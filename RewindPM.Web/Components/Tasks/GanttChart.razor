@using RewindPM.Application.Read.DTOs
@using TaskStatus = RewindPM.Domain.ValueObjects.TaskStatus
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="gantt-chart @(IsReadOnly ? "readonly-mode" : "")">
    @if (Tasks == null || !Tasks.Any())
    {
        <div class="gantt-empty">
            <p>タスクがありません</p>
        </div>
    }
    else if (TimelineStart == null || TimelineEnd == null)
    {
        <div class="gantt-empty">
            <p>予定期間が設定されたタスクがありません</p>
        </div>
    }
    else
    {
        <div class="gantt-container" @ref="scrollWrapperRef">
            @* ヘッダー行 *@
            <div class="gantt-header">
                <div class="gantt-header-task-name">タスク名</div>
                <div class="gantt-header-timeline-wrapper">
                    <div class="gantt-header-timeline">
                        @* 月の行 *@
                        <div class="gantt-month-row">
                            <div class="gantt-timeline-grid" style="grid-template-columns: repeat(@TotalDays, minmax(40px, 1fr));">
                                @foreach (var monthGroup in GetMonthGroups())
                                {
                                    <div class="gantt-month-cell" style="grid-column: @monthGroup.StartColumn / @monthGroup.EndColumn;">
                                        @monthGroup.Year/@monthGroup.Month
                                    </div>
                                }
                            </div>
                        </div>
                        @* 日の行 *@
                        <div class="gantt-date-row">
                            <div class="gantt-timeline-grid" style="grid-template-columns: repeat(@TotalDays, minmax(40px, 1fr));">
                                @for (int i = 0; i < TotalDays; i++)
                                {
                                    var date = TimelineStart.Value.AddDays(i);
                                    <div class="gantt-date-cell">
                                        <div class="gantt-date-label">@date.Day</div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @* コンテンツ行 *@
            <div class="gantt-content">
                @* タスク名列 *@
                <div class="gantt-task-names">
                    @foreach (var task in Tasks)
                    {
                        <div class="gantt-task-name-cell" title="@task.Title" @onclick="() => HandleTaskClick(task)">
                            <span class="gantt-task-title">@task.Title</span>
                            <span class="gantt-task-status gantt-status-@GetStatusClass(task.Status)">
                                @GetStatusLabel(task.Status)
                            </span>
                        </div>
                    }
                </div>

                @* タイムライン列（横スクロール） *@
                <div class="gantt-timeline-scroll" @ref="headerTimelineRef">
                    <div class="gantt-timeline-rows">
                        @foreach (var (task, index) in Tasks.Select((t, i) => (t, i)))
                        {
                            <div class="gantt-timeline-row" @ref="@timelineRefs[index]">
                                <div class="gantt-timeline-grid" style="grid-template-columns: repeat(@TotalDays, minmax(40px, 1fr));">
                                    @* 予定期間バー *@
                                    @if (task.ScheduledStartDate.HasValue && task.ScheduledEndDate.HasValue)
                                    {
                                        var gridColumn = GetGridColumn(task.ScheduledStartDate.Value, task.ScheduledEndDate.Value);
                                        <div class="gantt-bar gantt-bar-scheduled"
                                             style="grid-column: @gridColumn;"
                                             title="予定: @task.ScheduledStartDate.Value.ToString("yyyy/MM/dd") - @task.ScheduledEndDate.Value.ToString("yyyy/MM/dd")"
                                             data-task-id="@task.Id"
                                             data-bar-type="scheduled">
                                            @if (!IsReadOnly)
                                            {
                                                <div class="gantt-resize-handle gantt-resize-handle-left"></div>
                                                <div class="gantt-resize-handle gantt-resize-handle-right"></div>
                                            }
                                        </div>
                                    }

                                    @* 実績期間バー *@
                                    @if (task.ActualStartDate.HasValue && task.ActualEndDate.HasValue)
                                    {
                                        var gridColumn = GetGridColumn(task.ActualStartDate.Value, task.ActualEndDate.Value);
                                        <div class="gantt-bar gantt-bar-actual"
                                             style="grid-column: @gridColumn;"
                                             title="実績: @task.ActualStartDate.Value.ToString("yyyy/MM/dd") - @task.ActualEndDate.Value.ToString("yyyy/MM/dd")"
                                             data-task-id="@task.Id"
                                             data-bar-type="actual">
                                            @if (!IsReadOnly)
                                            {
                                                <div class="gantt-resize-handle gantt-resize-handle-left"></div>
                                                <div class="gantt-resize-handle gantt-resize-handle-right"></div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public List<TaskDto> Tasks { get; set; } = new();

    [Parameter]
    public EventCallback<TaskDto> OnTaskClick { get; set; }

    [Parameter]
    public EventCallback<(Guid taskId, string barType, DateTime newStartDate, DateTime newEndDate)> OnBarResize { get; set; }

    [Parameter]
    public DateTime? ViewDate { get; set; }

    [Parameter]
    public bool IsReadOnly { get; set; } = false;

    private DateTime? TimelineStart { get; set; }
    private DateTime? TimelineEnd { get; set; }
    private int TotalDays { get; set; }

    private ElementReference headerTimelineRef;
    private ElementReference[] timelineRefs = Array.Empty<ElementReference>();
    private ElementReference scrollWrapperRef;
    private DotNetObjectReference<GanttChart>? dotNetRef;
    private bool scriptsInitialized = false;

    protected override void OnParametersSet()
    {
        CalculateTimeline();
        // タスク数に応じてElementReference配列を再初期化
        if (Tasks != null)
        {
            timelineRefs = new ElementReference[Tasks.Count];
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender || !scriptsInitialized)
        {
            try
            {
                dotNetRef = DotNetObjectReference.Create(this);
                await JSRuntime.InvokeVoidAsync("ganttScrollSync.initialize", scrollWrapperRef, headerTimelineRef, timelineRefs, dotNetRef);
                scriptsInitialized = true;
            }
            catch (Exception)
            {
                // JavaScript初期化エラーをサイレントに処理
            }
        }
    }

    [JSInvokable]
    public async Task OnBarResized(string taskIdStr, string barType, int startDayIndex, int endDayIndex)
    {
        if (TimelineStart == null) return;

        if (!Guid.TryParse(taskIdStr, out var taskId)) return;

        // インデックスから日付を計算
        var newStartDate = TimelineStart.Value.AddDays(startDayIndex);
        var newEndDate = TimelineStart.Value.AddDays(endDayIndex);

        // コールバックを呼び出し
        if (OnBarResize.HasDelegate)
        {
            await OnBarResize.InvokeAsync((taskId, barType, newStartDate, newEndDate));
        }
    }

    public void Dispose()
    {
        try
        {
            JSRuntime.InvokeVoidAsync("ganttScrollSync.dispose");
        }
        catch { }

        dotNetRef?.Dispose();
    }

    private void CalculateTimeline()
    {
        if (Tasks == null || !Tasks.Any())
        {
            TimelineStart = null;
            TimelineEnd = null;
            TotalDays = 0;
            return;
        }

        // 全タスクの最も早い開始日と最も遅い終了日を取得
        var allDates = new List<DateTime>();

        foreach (var task in Tasks)
        {
            if (task.ScheduledStartDate.HasValue)
                allDates.Add(task.ScheduledStartDate.Value);
            if (task.ScheduledEndDate.HasValue)
                allDates.Add(task.ScheduledEndDate.Value);
            if (task.ActualStartDate.HasValue)
                allDates.Add(task.ActualStartDate.Value);
            if (task.ActualEndDate.HasValue)
                allDates.Add(task.ActualEndDate.Value);
        }

        if (!allDates.Any())
        {
            TimelineStart = null;
            TimelineEnd = null;
            TotalDays = 0;
            return;
        }

        TimelineStart = allDates.Min().Date;
        TimelineEnd = allDates.Max().Date;
        TotalDays = (int)(TimelineEnd.Value - TimelineStart.Value).TotalDays + 1;
    }

    private string GetGridColumn(DateTime startDate, DateTime endDate)
    {
        if (TimelineStart == null) return "1 / 2";

        // グリッドの開始列を計算（1-indexed）
        var startDay = (int)(startDate.Date - TimelineStart.Value).TotalDays + 1;
        var endDay = (int)(endDate.Date - TimelineStart.Value).TotalDays + 2; // 終了日は次の日の始まりまで

        // 範囲外の場合は調整
        startDay = Math.Max(1, Math.Min(startDay, TotalDays));
        endDay = Math.Max(startDay + 1, Math.Min(endDay, TotalDays + 1));

        return $"{startDay} / {endDay}";
    }

    private async Task HandleTaskClick(TaskDto task)
    {
        if (OnTaskClick.HasDelegate)
        {
            await OnTaskClick.InvokeAsync(task);
        }
    }

    private string GetStatusClass(TaskStatus status)
    {
        return status switch
        {
            TaskStatus.Todo => "todo",
            TaskStatus.InProgress => "inprogress",
            TaskStatus.InReview => "inreview",
            TaskStatus.Done => "done",
            _ => "todo"
        };
    }

    private string GetStatusLabel(TaskStatus status)
    {
        return status switch
        {
            TaskStatus.Todo => "TODO",
            TaskStatus.InProgress => "進行中",
            TaskStatus.InReview => "レビュー中",
            TaskStatus.Done => "完了",
            _ => "TODO"
        };
    }

    private List<MonthGroup> GetMonthGroups()
    {
        var groups = new List<MonthGroup>();
        if (TimelineStart == null || TotalDays == 0) return groups;

        var processedDays = 0;
        while (processedDays < TotalDays)
        {
            var currentDate = TimelineStart.Value.AddDays(processedDays);
            var currentMonth = currentDate.Month;
            var currentYear = currentDate.Year;
            var startColumn = processedDays + 1;

            // この月の日数をカウント
            var daysInThisMonth = 0;
            for (int i = processedDays; i < TotalDays; i++)
            {
                var checkDate = TimelineStart.Value.AddDays(i);
                if (checkDate.Month == currentMonth && checkDate.Year == currentYear)
                {
                    daysInThisMonth++;
                }
                else
                {
                    break;
                }
            }

            var endColumn = startColumn + daysInThisMonth;
            groups.Add(new MonthGroup
            {
                Year = currentYear,
                Month = currentMonth,
                StartColumn = startColumn,
                EndColumn = endColumn,
                DayCount = daysInThisMonth
            });

            processedDays += daysInThisMonth;
        }

        return groups;
    }

    private class MonthGroup
    {
        public int Year { get; set; }
        public int Month { get; set; }
        public int StartColumn { get; set; }
        public int EndColumn { get; set; }
        public int DayCount { get; set; }
    }
}
