@using RewindPM.Application.Read.DTOs
@using TaskStatus = RewindPM.Domain.ValueObjects.TaskStatus
@using Microsoft.JSInterop
@using RewindPM.Web.Components.Shared
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="gantt-chart @(IsReadOnly ? "readonly-mode" : "")">
    @if (Tasks == null || !Tasks.Any())
    {
        <div class="gantt-empty">
            <p>タスクがありません</p>
        </div>
    }
    else if (TimelineStart == null || TimelineEnd == null)
    {
        <div class="gantt-empty">
            <p>予定期間が設定されたタスクがありません</p>
        </div>
    }
    else
    {
        <div class="gantt-scroll-container" style="@(scriptsInitialized ? "" : "visibility: hidden;")">
            @* Zoom Toolbar - Floating at top-right *@
            <div class="gantt-zoom-toolbar">
                <button class="gantt-zoom-btn gantt-zoom-fit" @onclick="FitToScreen" title="全体を表示">
                    全体を表示
                </button>
                <div class="gantt-zoom-group">
                    <span class="gantt-zoom-label">横:</span>
                    <button class="gantt-zoom-btn" @onclick="ZoomOutHorizontal" disabled="@(!CanZoomOutHorizontal)" title="横方向縮小">
                        −
                    </button>
                    <button class="gantt-zoom-btn" @onclick="ZoomInHorizontal" disabled="@(!CanZoomInHorizontal)" title="横方向拡大">
                        +
                    </button>
                </div>
                <div class="gantt-zoom-group">
                    <span class="gantt-zoom-label">縦:</span>
                    <button class="gantt-zoom-btn" @onclick="ZoomOutVertical" disabled="@(!CanZoomOutVertical)" title="縦方向縮小">
                        −
                    </button>
                    <button class="gantt-zoom-btn" @onclick="ZoomInVertical" disabled="@(!CanZoomInVertical)" title="縦方向拡大">
                        +
                    </button>
                </div>
            </div>
            @* Header Row *@
            <div class="gantt-row gantt-header-row">
                <div class="gantt-cell gantt-sticky-left gantt-header-corner">タスク名</div>
                <div class="gantt-timeline-area">
                    @* Month Row *@
                    <div class="gantt-timeline-subrow">
                        <div class="gantt-timeline-grid" style="grid-template-columns: @GetGridTemplateColumns();">
                            @foreach (var monthGroup in GetMonthGroups())
                            {
                                <div class="gantt-month-cell" style="grid-column: @monthGroup.StartColumn / @monthGroup.EndColumn;">
                                    @monthGroup.Year/@monthGroup.Month
                                </div>
                            }
                        </div>
                    </div>
                    @* Date Row *@
                    <div class="gantt-timeline-subrow">
                        <div class="gantt-timeline-grid" style="grid-template-columns: @GetGridTemplateColumns();">
                            @for (int i = 0; i < TotalDays; i++)
                            {
                                var date = TimelineStart.Value.AddDays(i);
                                <div class="gantt-date-cell">
                                    @if (ShouldDisplayDateLabel(i))
                                    {
                                        <div class="gantt-date-label">@date.Day</div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            @* Task Rows *@
            @foreach (var (task, index) in Tasks.Select((t, i) => (t, i)))
            {
                <div class="gantt-row gantt-task-row">
                    <div class="gantt-cell gantt-sticky-left gantt-task-name-cell" style="@GetRowHeightStyle()" title="@task.Title" @onclick="() => HandleTaskClick(task)">
                        <span class="gantt-task-title">@task.Title</span>
                        <span class="gantt-task-status gantt-status-@GetStatusClass(task.Status)" style="@GetStatusBadgeStyle()">
                            @GetStatusLabel(task.Status)
                        </span>
                    </div>
                    <div class="gantt-timeline-area" style="@GetRowHeightStyle()">
                        <div class="gantt-timeline-grid" style="grid-template-columns: @GetGridTemplateColumns();">
                            @* Scheduled Bar *@
                            @if (ShouldDisplayBar(task.Id, "scheduled"))
                            {
                                var barState = GetDisplayBarState(task.Id, "scheduled");
                                if (barState != null)
                                {
                                    var gridColumn = GetGridColumn(barState.StartDate, barState.EndDate);
                                    var animationClass = GetBarAnimationClass(task.Id, "scheduled");
                                    <div class="gantt-bar gantt-bar-scheduled @animationClass"
                                         style="grid-column: @gridColumn; @GetBarMarginStyle("scheduled")"
                                         title="予定: @barState.StartDate.ToString("yyyy/MM/dd") - @barState.EndDate.ToString("yyyy/MM/dd")"
                                         data-task-id="@task.Id"
                                         data-bar-type="scheduled">
                                        @if (!IsReadOnly && string.IsNullOrEmpty(animationClass))
                                        {
                                            <div class="gantt-resize-handle gantt-resize-handle-left"></div>
                                            <div class="gantt-resize-handle gantt-resize-handle-right"></div>
                                        }
                                    </div>
                                }
                            }

                            @* Actual Bar *@
                            @if (ShouldDisplayBar(task.Id, "actual"))
                            {
                                var barState = GetDisplayBarState(task.Id, "actual");
                                if (barState != null)
                                {
                                    var gridColumn = GetGridColumn(barState.StartDate, barState.EndDate);
                                    var animationClass = GetBarAnimationClass(task.Id, "actual");
                                    <div class="gantt-bar gantt-bar-actual @animationClass"
                                         style="grid-column: @gridColumn; @GetBarMarginStyle("actual")"
                                         title="実績: @barState.StartDate.ToString("yyyy/MM/dd") - @barState.EndDate.ToString("yyyy/MM/dd")"
                                         data-task-id="@task.Id"
                                         data-bar-type="actual">
                                        @if (!IsReadOnly && string.IsNullOrEmpty(animationClass))
                                        {
                                            <div class="gantt-resize-handle gantt-resize-handle-left"></div>
                                            <div class="gantt-resize-handle gantt-resize-handle-right"></div>
                                        }
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter]
    public List<TaskDto> Tasks { get; set; } = new();

    [Parameter]
    public EventCallback<TaskDto> OnTaskClick { get; set; }

    [Parameter]
    public EventCallback<(Guid taskId, string barType, DateTimeOffset newStartDate, DateTimeOffset newEndDate)> OnBarResize { get; set; }

    [Parameter]
    public DateTimeOffset? ViewDate { get; set; }

    [Parameter]
    public bool IsReadOnly { get; set; } = false;

    [Parameter]
    public EventCallback<double> OnZoomChanged { get; set; }

    // ヘルパークラス
    private readonly GanttTimelineCalculator _timelineCalculator = new();
    private readonly GanttZoomManager _zoomManager = new();
    private readonly GanttBarAnimationManager _animationManager = new();

    private double availableTimelineWidth = 0;
    private double availableTimelineHeight = 0;

    private DotNetObjectReference<GanttChart>? dotNetRef;
    private bool scriptsInitialized = false;

    // ヘルパープロパティ
    private DateTime? TimelineStart => _timelineCalculator.TimelineStart;
    private DateTime? TimelineEnd => _timelineCalculator.TimelineEnd;
    private int TotalDays => _timelineCalculator.TotalDays;

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();

        if (_animationManager.IsInitialLoad())
        {
            _animationManager.InitializeBarStates(Tasks);
            _animationManager.InitializeDisplayBarStates();
        }
        else
        {
            await HandleBarsChanged();
        }

        var timelineChanged = _timelineCalculator.CalculateTimeline(Tasks);
        if (timelineChanged)
        {
            // タイムラインが変更された場合、基準値を再計算
            _zoomManager.CalculateBaseColumnWidth(TotalDays, availableTimelineWidth);
            _zoomManager.CalculateBaseRowHeight(Tasks?.Count ?? 0, availableTimelineHeight);
        }
    }

    private async Task HandleBarsChanged()
    {
        var currentBarStates = _animationManager.GetCurrentBarStates(Tasks);
        var removedBars = _animationManager.GetRemovedBars(currentBarStates);

        if (removedBars.Any())
        {
            await AnimateBarRemoval(removedBars);
        }
        else
        {
            _animationManager.DetectChangesAndUpdate(Tasks);
            _animationManager.UpdateDisplayBarStates();
        }

        _animationManager.UpdatePreviousBarStates(currentBarStates);
    }

    private async Task AnimateBarRemoval(List<string> removedBars)
    {
        _animationManager.PrepareBarRemovalAnimation(removedBars);
        StateHasChanged();

        await Task.Delay(AnimationConstants.FadeOutDurationMs);

        _animationManager.CompleteBarRemovalAnimation();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender || !scriptsInitialized)
        {
            try
            {
                await LoadZoomLevelsFromStorage();

                dotNetRef = DotNetObjectReference.Create(this);
                await JSRuntime.InvokeVoidAsync("ganttScrollSync.initialize", dotNetRef);

                availableTimelineWidth = await JSRuntime.InvokeAsync<double>("ganttZoom.getAvailableWidth");
                availableTimelineHeight = await JSRuntime.InvokeAsync<double>("ganttZoom.getAvailableHeight");
                _zoomManager.CalculateBaseColumnWidth(TotalDays, availableTimelineWidth);
                _zoomManager.CalculateBaseRowHeight(Tasks?.Count ?? 0, availableTimelineHeight);

                await JSRuntime.InvokeVoidAsync("ganttZoom.initializeDraggableToolbar");

                scriptsInitialized = true;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"ガントチャートの初期化エラー: {ex.Message}");
            }
        }
        else
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("ganttScrollSync.reinitializeResizeHandles");
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"リサイズハンドルの再初期化エラー: {ex.Message}");
            }
        }
    }

    [JSInvokable]
    public async Task OnBarResized(string taskIdStr, string barType, int startDayIndex, int endDayIndex)
    {
        if (TimelineStart == null) return;

        if (!Guid.TryParse(taskIdStr, out var taskId)) return;

        // インデックスから日付を計算（UTC offsetで統一）
        var newStartDate = new DateTimeOffset(TimelineStart.Value.AddDays(startDayIndex), TimeSpan.Zero);
        var newEndDate = new DateTimeOffset(TimelineStart.Value.AddDays(endDayIndex), TimeSpan.Zero);

        // コールバックを呼び出し
        if (OnBarResize.HasDelegate)
        {
            await OnBarResize.InvokeAsync((taskId, barType, newStartDate, newEndDate));
        }
    }

    public void Dispose()
    {
        try
        {
            JSRuntime.InvokeVoidAsync("ganttScrollSync.dispose");
        }
        catch { }

        dotNetRef?.Dispose();
    }

    private string GetGridColumn(DateTimeOffset startDate, DateTimeOffset endDate)
    {
        return _timelineCalculator.GetGridColumn(startDate, endDate);
    }

    private async Task HandleTaskClick(TaskDto task)
    {
        if (OnTaskClick.HasDelegate)
        {
            await OnTaskClick.InvokeAsync(task);
        }
    }

    private string GetStatusClass(TaskStatus status)
    {
        return status switch
        {
            TaskStatus.Todo => "todo",
            TaskStatus.InProgress => "inprogress",
            TaskStatus.InReview => "inreview",
            TaskStatus.Done => "done",
            _ => "todo"
        };
    }

    private string GetStatusLabel(TaskStatus status)
    {
        return status switch
        {
            TaskStatus.Todo => "未着手",
            TaskStatus.InProgress => "進行中",
            TaskStatus.InReview => "レビュー中",
            TaskStatus.Done => "完了",
            _ => "未着手"
        };
    }

    private List<GanttTimelineCalculator.MonthGroup> GetMonthGroups()
    {
        return _timelineCalculator.GetMonthGroups();
    }

    private bool ShouldDisplayBar(Guid taskId, string barType)
    {
        return _animationManager.ShouldDisplayBar(taskId, barType);
    }

    private GanttBarAnimationManager.BarState? GetDisplayBarState(Guid taskId, string barType)
    {
        return _animationManager.GetDisplayBarState(taskId, barType);
    }

    private string GetBarAnimationClass(Guid taskId, string barType)
    {
        return _animationManager.GetBarAnimationClass(taskId, barType);
    }

    // ========== ズーム機能 ==========

    private string GetGridTemplateColumns()
    {
        var cellWidth = _zoomManager.GetActualCellWidth();
        return $"repeat({TotalDays}, {cellWidth}px)";
    }

    private string GetRowHeightStyle()
    {
        var rowHeight = _zoomManager.GetActualRowHeight();
        return $"height: {rowHeight}px;";
    }

    private string GetStatusBadgeStyle()
    {
        var rowHeight = _zoomManager.GetActualRowHeight();
        var fontSize = rowHeight * GanttConstants.StatusBadge.FontSizeRatio;
        fontSize = Math.Max(GanttConstants.StatusBadge.MinFontSize, Math.Min(GanttConstants.StatusBadge.MaxFontSize, fontSize));

        var paddingVertical = rowHeight * GanttConstants.StatusBadge.PaddingVerticalRatio;
        paddingVertical = Math.Max(GanttConstants.StatusBadge.MinPaddingVertical, Math.Min(GanttConstants.StatusBadge.MaxPaddingVertical, paddingVertical));

        var paddingHorizontal = rowHeight * GanttConstants.StatusBadge.PaddingHorizontalRatio;
        paddingHorizontal = Math.Max(GanttConstants.StatusBadge.MinPaddingHorizontal, Math.Min(GanttConstants.StatusBadge.MaxPaddingHorizontal, paddingHorizontal));

        return $"font-size: {fontSize}rem; padding: {paddingVertical}px {paddingHorizontal}px;";
    }

    private string GetBarMarginStyle(string barType)
    {
        var rowHeight = _zoomManager.GetActualRowHeight();
        var barHeight = _zoomManager.GetBarHeight();
        var gap = _zoomManager.GetBarGap();
        var verticalMargin = (rowHeight - barHeight - barHeight - gap) / 2;

        if (barType == "scheduled")
        {
            return $"height: {barHeight}px; margin-top: {verticalMargin}px; margin-bottom: {gap}px;";
        }
        else
        {
            return $"height: {barHeight}px; margin-top: {gap}px; margin-bottom: {verticalMargin}px;";
        }
    }

    private bool CanZoomInHorizontal => _zoomManager.CanZoomInHorizontal;
    private bool CanZoomOutHorizontal => _zoomManager.CanZoomOutHorizontal;
    private bool CanZoomInVertical => _zoomManager.CanZoomInVertical;
    private bool CanZoomOutVertical => _zoomManager.CanZoomOutVertical;

    private async Task ZoomInHorizontal()
    {
        if (_zoomManager.CanZoomInHorizontal)
        {
            _zoomManager.ZoomInHorizontal();
            await SaveZoomLevelsToStorage();
            if (OnZoomChanged.HasDelegate)
            {
                await OnZoomChanged.InvokeAsync(_zoomManager.HorizontalZoomScale);
            }
            StateHasChanged();
        }
    }

    private async Task ZoomOutHorizontal()
    {
        if (_zoomManager.CanZoomOutHorizontal)
        {
            _zoomManager.ZoomOutHorizontal();
            await SaveZoomLevelsToStorage();
            if (OnZoomChanged.HasDelegate)
            {
                await OnZoomChanged.InvokeAsync(_zoomManager.HorizontalZoomScale);
            }
            StateHasChanged();
        }
    }

    private async Task ZoomInVertical()
    {
        if (_zoomManager.CanZoomInVertical)
        {
            _zoomManager.ZoomInVertical();
            await SaveZoomLevelsToStorage();
            StateHasChanged();
        }
    }

    private async Task ZoomOutVertical()
    {
        if (_zoomManager.CanZoomOutVertical)
        {
            _zoomManager.ZoomOutVertical();
            await SaveZoomLevelsToStorage();
            StateHasChanged();
        }
    }

    private async Task FitToScreen()
    {
        _zoomManager.FitToScreen(TotalDays, Tasks?.Count ?? 0, availableTimelineWidth, availableTimelineHeight);
        await SaveZoomLevelsToStorage();
        if (OnZoomChanged.HasDelegate)
        {
            await OnZoomChanged.InvokeAsync(_zoomManager.HorizontalZoomScale);
        }
        StateHasChanged();
    }

    private async Task LoadZoomLevelsFromStorage()
    {
        try
        {
            var hZoom = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", GanttConstants.StorageKeys.HorizontalZoom);
            var vZoom = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", GanttConstants.StorageKeys.VerticalZoom);

            var hZoomIndex = hZoom != null && int.TryParse(hZoom, out var h) ? h : 0;
            var vZoomIndex = vZoom != null && int.TryParse(vZoom, out var v) ? v : 0;

            _zoomManager.RestoreZoomLevels(hZoomIndex, vZoomIndex);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"ローカルストレージからズームレベルを読み取れませんでした: {ex.Message}");
        }
    }

    private async Task SaveZoomLevelsToStorage()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", GanttConstants.StorageKeys.HorizontalZoom, _zoomManager.HorizontalZoomLevelIndex.ToString());
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", GanttConstants.StorageKeys.VerticalZoom, _zoomManager.VerticalZoomLevelIndex.ToString());
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"ローカルストレージにズームレベルを保存できませんでした: {ex.Message}");
        }
    }

    private bool ShouldDisplayDateLabel(int dayIndex)
    {
        if (TimelineStart == null) return false;
        var date = TimelineStart.Value.AddDays(dayIndex);
        return _zoomManager.ShouldDisplayDateLabel(dayIndex, date.Day);
    }
}
