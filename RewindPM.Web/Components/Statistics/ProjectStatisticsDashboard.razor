@using MediatR
@using RewindPM.Application.Read.DTOs
@using RewindPM.Application.Read.Queries.Statistics
@using Microsoft.Extensions.Logging

@inject IMediator Mediator
@inject ILogger<ProjectStatisticsDashboard> Logger

@if (_isLoading)
{
    <div class="statistics-loading">
        <p>統計情報を読み込み中...</p>
    </div>
}
else if (_statistics != null)
{
    <div class="statistics-dashboard">
        <h3>プロジェクト統計</h3>
        
        <div class="statistics-grid">
            <!-- タスク統計カード -->
            <div class="stat-card">
                <div class="stat-card-header">
                    <h4>タスク進捗</h4>
                </div>
                <div class="stat-card-content">
                    <div class="stat-primary">
                        <span class="stat-value">@_statistics.CompletionRate%</span>
                        <span class="stat-label">完了率</span>
                    </div>
                    <div class="stat-details">
                        <div class="stat-detail-item">
                            <span class="stat-detail-label">合計:</span>
                            <span class="stat-detail-value">@_statistics.TotalTasks</span>
                        </div>
                        <div class="stat-detail-item">
                            <span class="stat-detail-label">完了:</span>
                            <span class="stat-detail-value stat-completed">@_statistics.CompletedTasks</span>
                        </div>
                        <div class="stat-detail-item">
                            <span class="stat-detail-label">進行中:</span>
                            <span class="stat-detail-value stat-in-progress">@_statistics.InProgressTasks</span>
                        </div>
                        <div class="stat-detail-item">
                            <span class="stat-detail-label">レビュー中:</span>
                            <span class="stat-detail-value stat-in-review">@_statistics.InReviewTasks</span>
                        </div>
                        <div class="stat-detail-item">
                            <span class="stat-detail-label">未着手:</span>
                            <span class="stat-detail-value stat-todo">@_statistics.TodoTasks</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 工数統計カード -->
            <div class="stat-card">
                <div class="stat-card-header">
                    <h4>工数統計</h4>
                </div>
                <div class="stat-card-content">
                    <div class="stat-primary">
                        <span class="stat-value @GetConsumptionRateClass()">@_statistics.HoursConsumptionRate%</span>
                        <span class="stat-label">工数消費率</span>
                    </div>
                    <div class="stat-details">
                        <div class="stat-detail-item">
                            <span class="stat-detail-label">予定工数:</span>
                            <span class="stat-detail-value">@_statistics.TotalEstimatedHours h</span>
                        </div>
                        <div class="stat-detail-item">
                            <span class="stat-detail-label">実績工数:</span>
                            <span class="stat-detail-value">@_statistics.TotalActualHours h</span>
                        </div>
                        <div class="stat-detail-item">
                            <span class="stat-detail-label">残予定工数:</span>
                            <span class="stat-detail-value">@_statistics.RemainingEstimatedHours h</span>
                        </div>
                        <div class="stat-detail-item">
                            <span class="stat-detail-label">工数差分:</span>
                            <span class="stat-detail-value @GetOverrunClass()">@GetHoursOverrunText()</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- スケジュール統計カード -->
            <div class="stat-card">
                <div class="stat-card-header">
                    <h4>スケジュール統計</h4>
                </div>
                <div class="stat-card-content">
                    <div class="stat-primary">
                        <span class="stat-value @GetOnTimeRateClass()">@_statistics.OnTimeRate%</span>
                        <span class="stat-label">期限内完了率</span>
                    </div>
                    <div class="stat-details">
                        <div class="stat-detail-item">
                            <span class="stat-detail-label">期限内:</span>
                            <span class="stat-detail-value stat-on-time">@_statistics.OnTimeTasks</span>
                        </div>
                        <div class="stat-detail-item">
                            <span class="stat-detail-label">遅延:</span>
                            <span class="stat-detail-value stat-delayed">@_statistics.DelayedTasks</span>
                        </div>
                        <div class="stat-detail-item">
                            <span class="stat-detail-label">平均遅延:</span>
                            <span class="stat-detail-value">@_statistics.AverageDelayDays 日</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 見積もり精度カード -->
            <div class="stat-card">
                <div class="stat-card-header">
                    <h4>見積もり精度</h4>
                </div>
                <div class="stat-card-content">
                    <div class="stat-primary">
                        <span class="stat-value @GetEstimateAccuracyClass()">@_statistics.EstimateAccuracyRate%</span>
                        <span class="stat-label">見積もり精度率</span>
                    </div>
                    <div class="stat-details">
                        <div class="stat-detail-item">
                            <span class="stat-detail-label">正確:</span>
                            <span class="stat-detail-value stat-good">@_statistics.AccurateEstimateTasks</span>
                        </div>
                        <div class="stat-detail-item">
                            <span class="stat-detail-label">過大見積:</span>
                            <span class="stat-detail-value stat-under">@_statistics.OverEstimateTasks</span>
                        </div>
                        <div class="stat-detail-item">
                            <span class="stat-detail-label">過小見積:</span>
                            <span class="stat-detail-value stat-over">@_statistics.UnderEstimateTasks</span>
                        </div>
                        <div class="stat-detail-item">
                            <span class="stat-detail-label">平均誤差:</span>
                            <span class="stat-detail-value">@_statistics.AverageEstimateErrorDays 日</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        @if (_statistics.AsOfDate.Date < DateTimeOffset.UtcNow.Date)
        {
            <div class="rewind-notice">
                <p>⏰ リワインド表示中: @_statistics.AsOfDate.ToString("yyyy年MM月dd日") 時点の統計</p>
            </div>
        }

        <!-- グラフセクション -->
        <div class="charts-section">
            <div class="chart-row">
                <div class="chart-container">
                    <CumulativeFlowDiagram ProjectId="@ProjectId" AsOfDate="@AsOfDate" />
                </div>
            </div>

            <div class="chart-row">
                <div class="chart-container">
                    <BurndownChart ProjectId="@ProjectId" AsOfDate="@AsOfDate" />
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="statistics-error">
        <p>統計情報を取得できませんでした。</p>
    </div>
}

@code {
    [Parameter]
    public required Guid ProjectId { get; set; }
    
    [Parameter]
    public DateTimeOffset? AsOfDate { get; set; }

    private ProjectStatisticsDetailDto? _statistics;
    private bool _isLoading = true;
    
    // パラメータ変更検知用
    private Guid _prevProjectId;
    private DateTimeOffset? _prevAsOfDate;

    // 見積もり精度の閾値定数
    /// <summary>
    /// 見積もり精度が良好と判定される閾値（80%以上）
    /// </summary>
    private const double GoodEstimateAccuracyThreshold = 80.0;

    /// <summary>
    /// 見積もり精度が警告レベルと判定される閾値（60%以上80%未満）
    /// </summary>
    private const double WarningEstimateAccuracyThreshold = 60.0;

    protected override async Task OnInitializedAsync()
    {
        // 初期化時は必ず読み込む
        await LoadStatisticsAsync();
        _prevProjectId = ProjectId;
        _prevAsOfDate = AsOfDate;
    }

    protected override async Task OnParametersSetAsync()
    {
        // パラメータが変更された場合のみ再読み込み
        if (_prevProjectId != ProjectId || _prevAsOfDate != AsOfDate)
        {
            await LoadStatisticsAsync();
            _prevProjectId = ProjectId;
            _prevAsOfDate = AsOfDate;
        }
    }

    private async Task LoadStatisticsAsync()
    {
        _isLoading = true;
        
        try
        {
            var query = new GetProjectStatisticsDetailQuery(ProjectId, AsOfDate);
            _statistics = await Mediator.Send(query);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "プロジェクト統計情報の取得に失敗しました。ProjectId: {ProjectId}, AsOfDate: {AsOfDate}", ProjectId, AsOfDate);
            _statistics = null;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string GetConsumptionRateClass()
    {
        if (_statistics == null) return "";

        // 工数消費率が100%を超える場合は予定より多くの工数を消費（赤）
        if (_statistics.HoursConsumptionRate > 100)
            return "stat-over";
        // 工数消費率が100%未満の場合は予定より少ない工数で完了（緑）
        else if (_statistics.HoursConsumptionRate < 100)
            return "stat-under";

        return "";
    }

    private string GetOverrunClass()
    {
        if (_statistics == null) return "";

        if (_statistics.HoursOverrun > 0)
            return "stat-over";
        else if (_statistics.HoursOverrun < 0)
            return "stat-under";

        return "";
    }

    private string GetHoursOverrunText()
    {
        if (_statistics == null) return "";
        
        var hours = _statistics.HoursOverrun;
        return hours > 0 ? $"+{hours} h" : $"{hours} h";
    }

    private string GetOnTimeRateClass()
    {
        if (_statistics == null) return "";

        if (_statistics.OnTimeRate >= GoodEstimateAccuracyThreshold)
            return "stat-good";
        else if (_statistics.OnTimeRate >= WarningEstimateAccuracyThreshold)
            return "stat-warning";

        return "stat-bad";
    }

    private string GetEstimateAccuracyClass()
    {
        if (_statistics == null) return "";

        if (_statistics.EstimateAccuracyRate >= GoodEstimateAccuracyThreshold)
            return "stat-good";
        else if (_statistics.EstimateAccuracyRate >= WarningEstimateAccuracyThreshold)
            return "stat-warning";

        return "stat-bad";
    }
}
