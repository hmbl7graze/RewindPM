@using MediatR
@using RewindPM.Application.Read.Queries.Statistics
@using RewindPM.Application.Read.Queries.Projects
@using RewindPM.Application.Read.DTOs

@inject IMediator Mediator
@inject ILogger<CumulativeFlowDiagram> Logger

@if (_isLoading)
{
    <div class="chart-loading">
        <p>チャートを読み込み中...</p>
    </div>
}
else if (_chartData != null && _chartData.Any())
{
    <div class="cumulative-flow-diagram">
        <h4>累積フローダイアグラム</h4>
        <ApexChart TItem="ChartDataPoint"
                   Title="タスクステータスの推移"
                   XAxisType="XAxisType.Datetime"
                   Options="options"
                   Height="400">

            <ApexPointSeries TItem="ChartDataPoint"
                             Items="_completedData"
                             Name="完了"
                             SeriesType="SeriesType.Area"
                             XValue="@(e => e.X.ToUnixTimeMilliseconds())"
                             YAggregate="@(e => e.Sum(y => y.Y))"
                             Color="var(--chart-done)" />

            <ApexPointSeries TItem="ChartDataPoint"
                             Items="_inReviewData"
                             Name="レビュー中"
                             SeriesType="SeriesType.Area"
                             XValue="@(e => e.X.ToUnixTimeMilliseconds())"
                             YAggregate="@(e => e.Sum(y => y.Y))"
                             Color="var(--chart-inreview)" />

            <ApexPointSeries TItem="ChartDataPoint"
                             Items="_inProgressData"
                             Name="進行中"
                             SeriesType="SeriesType.Area"
                             XValue="@(e => e.X.ToUnixTimeMilliseconds())"
                             YAggregate="@(e => e.Sum(y => y.Y))"
                             Color="var(--chart-inprogress)" />

            <ApexPointSeries TItem="ChartDataPoint"
                             Items="_todoData"
                             Name="未着手"
                             SeriesType="SeriesType.Area"
                             XValue="@(e => e.X.ToUnixTimeMilliseconds())"
                             YAggregate="@(e => e.Sum(y => y.Y))"
                             Color="var(--chart-todo)" />
        </ApexChart>
    </div>
}
else
{
    <div class="chart-error">
        <p>表示するデータがありません</p>
    </div>
}

@code {
    [Parameter]
    public required Guid ProjectId { get; set; }

    [Parameter]
    public DateTimeOffset? AsOfDate { get; set; }

    private List<DailyStatisticsSnapshot>? _chartData;
    private List<ChartDataPoint> _completedData = new();
    private List<ChartDataPoint> _inProgressData = new();
    private List<ChartDataPoint> _inReviewData = new();
    private List<ChartDataPoint> _todoData = new();
    private bool _isLoading = true;
    private ApexChartOptions<ChartDataPoint> options = new();

    protected override void OnInitialized()
    {
        options = new ApexChartOptions<ChartDataPoint>
            {
                Chart = new Chart
                {
                    Toolbar = new Toolbar
                    {
                        Show = false
                    }
                },
                Legend = new Legend
                {
                    Position = LegendPosition.Right
                },
                Tooltip = new Tooltip
                {
                    Enabled = false,
                },
                Fill = new Fill
                {
                    Type = FillType.Gradient,
                    Gradient = new FillGradient
                    {
                        Type = GradientType.Vertical,
                        GradientToColors = new List<string> { "#ffffff", "#ffffff", "#ffffff", "#ffffff" },
                        OpacityFrom = 0.9,
                        OpacityTo = 0.3,
                    }
                },
            };
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadChartDataAsync();
    }

    private async Task LoadChartDataAsync()
    {
        _isLoading = true;

        try
        {
            // プロジェクトの編集日一覧を取得してグラフの範囲を決定
            var editDatesQuery = new GetProjectEditDatesQuery(ProjectId, Ascending: true);
            var editDates = await Mediator.Send(editDatesQuery);

            DateTimeOffset startDate;
            DateTimeOffset endDate;

            if (editDates != null && editDates.Any())
            {
                // 最初の編集日から開始
                startDate = editDates.First();
                // リワインド時はAsOfDate、通常時は最後の編集日
                endDate = AsOfDate ?? editDates.Last();
            }
            else
            {
                // フォールバック: 編集履歴がない場合は30日前から
                endDate = AsOfDate ?? DateTimeOffset.UtcNow;
                startDate = endDate.AddDays(-30);
            }

            var query = new GetProjectStatisticsTimeSeriesQuery(ProjectId, startDate, endDate);
            var timeSeriesData = await Mediator.Send(query);

            if (timeSeriesData != null && timeSeriesData.DailySnapshots.Any())
            {
                _chartData = timeSeriesData.DailySnapshots;

                _completedData = new List<ChartDataPoint>();
                _inReviewData = new List<ChartDataPoint>();
                _inProgressData = new List<ChartDataPoint>();
                _todoData = new List<ChartDataPoint>();

                foreach (var snapshot in _chartData)
                {
                    // 累積フローダイアグラムでは、各ステータスの値を積み重ねて表示
                    // 下から順に: 完了 → レビュー中 → 進行中 → 未着手
                    
                    _completedData.Add(new ChartDataPoint { X = snapshot.Date, Y = snapshot.CompletedTasks });
                    _inReviewData.Add(new ChartDataPoint { X = snapshot.Date, Y = snapshot.InReviewTasks });
                    _inProgressData.Add(new ChartDataPoint { X = snapshot.Date, Y = snapshot.InProgressTasks });
                    _todoData.Add(new ChartDataPoint { X = snapshot.Date, Y = snapshot.TodoTasks });
                }
            }
            else
            {
                _chartData = null;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Cumulative Flow Diagramの読み込みに失敗しました。ProjectId: {ProjectId}", ProjectId);
            _chartData = null;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private class ChartDataPoint
    {
        public required DateTimeOffset X { get; set; }
        public required int Y { get; set; }
    }
}
