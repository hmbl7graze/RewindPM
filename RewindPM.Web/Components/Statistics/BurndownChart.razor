@using MediatR
@using RewindPM.Application.Read.Queries.Statistics
@using RewindPM.Application.Read.Queries.Projects
@using RewindPM.Application.Read.Queries.Tasks
@using RewindPM.Application.Read.DTOs

@inject IMediator Mediator
@inject ILogger<BurndownChart> Logger

@if (_isLoading)
{
    <div class="chart-loading">
        <p>チャートを読み込み中...</p>
    </div>
}
else if (_actualData != null && _actualData.Any())
{
    <div class="burndown-chart">
        <h4>バーンダウンチャート</h4>
        <ApexChart TItem="ChartDataPoint"
                   Title="残タスク数の推移"
                   XAxisType="XAxisType.Datetime"
                   Options="options"
                   Height="400">

            @* 理想線（予定） *@
            <ApexPointSeries TItem="ChartDataPoint"
                             Items="_idealData"
                             Name="理想線"
                             SeriesType="SeriesType.Line"
                             XValue="@(e => e.X.ToUnixTimeMilliseconds())"
                             YAggregate="@(e => e.Sum(y => y.Y))"
                             OrderBy="e => e.X"
                             Color="#adb5bd" />

            @* 実績線 *@
            <ApexPointSeries TItem="ChartDataPoint"
                             Items="_actualData"
                             Name="実績"
                             SeriesType="SeriesType.Line"
                             XValue="@(e => e.X.ToUnixTimeMilliseconds())"
                             YAggregate="@(e => e.Sum(y => y.Y))"
                             OrderBy="e => e.X"
                             Color="#007bff" />
        </ApexChart>
    </div>
}
else
{
    <div class="chart-error">
        <p>表示するデータがありません</p>
    </div>
}

@code {
    [Parameter]
    public required Guid ProjectId { get; set; }

    [Parameter]
    public DateTimeOffset? AsOfDate { get; set; }

    private List<ChartDataPoint>? _actualData;
    private List<ChartDataPoint>? _idealData;
    private bool _isLoading = true;
    private ApexChartOptions<ChartDataPoint> options = new();

    protected override void OnInitialized()
    {
        options = new ApexChartOptions<ChartDataPoint>
            {
                Chart = new Chart
                {
                    Toolbar = new Toolbar
                    {
                        Show = false
                    }
                },
                Legend = new Legend
                {
                    Position = LegendPosition.Right
                },
                Tooltip = new Tooltip
                {
                    Enabled = false,
                },
            };
    }
    
    protected override async Task OnParametersSetAsync()
    {
        await LoadChartDataAsync();
    }

    private async Task LoadChartDataAsync()
    {
        _isLoading = true;

        try
        {
            // プロジェクトの編集日一覧を取得してグラフの範囲を決定
            var editDatesQuery = new GetProjectEditDatesQuery(ProjectId, Ascending: true);
            var editDates = await Mediator.Send(editDatesQuery);

            DateTimeOffset startDate;
            DateTimeOffset chartEndDate;  // チャート表示範囲の終了日
            DateTimeOffset? actualDataEndDate;  // 実績データの終了日(AsOfDate)

            if (editDates != null && editDates.Any())
            {
                // 最初の編集日から開始
                startDate = editDates.First();
                actualDataEndDate = AsOfDate;  // リワインド時の実績データの終了日
            }
            else
            {
                // フォールバック: 編集履歴がない場合は30日前から
                actualDataEndDate = AsOfDate ?? DateTimeOffset.UtcNow;
                startDate = actualDataEndDate.Value.AddDays(-30);
            }

            // 開始時点でのタスク一覧を取得して、プロジェクトの終了日を決定
            var tasksQuery = new GetTasksByProjectIdAtTimeQuery(ProjectId, startDate);
            var tasksAtStart = await Mediator.Send(tasksQuery);

            if (tasksAtStart != null && tasksAtStart.Any())
            {
                // タスクの最も遅い予定終了日をチャートの終了日とする
                var latestScheduledEndDate = tasksAtStart
                    .Where(t => t.ScheduledEndDate.HasValue)
                    .Select(t => t.ScheduledEndDate!.Value)
                    .DefaultIfEmpty(actualDataEndDate ?? DateTimeOffset.UtcNow)
                    .Max();

                chartEndDate = latestScheduledEndDate;

                // リワインドモードでない場合は、現在の編集日の最新まで表示
                if (!AsOfDate.HasValue && editDates != null && editDates.Any())
                {
                    chartEndDate = new[] { chartEndDate, editDates.Last() }.Max();
                }
            }
            else
            {
                // タスクがない場合
                // リワインドモードの場合はAsOfDate、通常モードの場合は最後の編集日またはDateTimeOffset.UtcNow
                if (actualDataEndDate.HasValue)
                {
                    chartEndDate = actualDataEndDate.Value;
                }
                else if (editDates != null && editDates.Any())
                {
                    chartEndDate = editDates.Last();
                }
                else
                {
                    chartEndDate = DateTimeOffset.UtcNow;
                }
            }

            var query = new GetProjectStatisticsTimeSeriesQuery(ProjectId, startDate, chartEndDate);
            var timeSeriesData = await Mediator.Send(query);

            if (timeSeriesData != null && timeSeriesData.DailySnapshots.Any())
            {
                var snapshots = timeSeriesData.DailySnapshots;

                // 実績線データを作成（リワインド時はAsOfDateまでのデータのみ）
                _actualData = snapshots
                    .Where(s => !actualDataEndDate.HasValue || s.Date <= actualDataEndDate.Value)
                    .Select(s => new ChartDataPoint
                    {
                        X = s.Date,
                        Y = s.RemainingTasks
                    })
                    .ToList();

                // 理想線データを作成：開始時点でのタスクの予定終了日に基づいて計算
                if (tasksAtStart != null && tasksAtStart.Any())
                {
                    var totalTasks = tasksAtStart.Count;

                    _idealData = snapshots
                        .Select(s =>
                        {
                            // この日付までに予定終了日を迎えるべきタスク数（完了予定）
                            var shouldBeCompleted = tasksAtStart.Count(t =>
                                t.ScheduledEndDate.HasValue &&
                                t.ScheduledEndDate.Value.Date <= s.Date.DateTime.Date);

                            // 理想的な残タスク数
                            var idealRemaining = totalTasks - shouldBeCompleted;

                            return new ChartDataPoint
                            {
                                X = s.Date,
                                Y = idealRemaining
                            };
                        })
                        .ToList();
                }
                else
                {
                    // タスクがない場合は理想線を表示しない
                    _idealData = null;
                }
            }
            else
            {
                _actualData = null;
                _idealData = null;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Burndown Chartの読み込みに失敗しました。ProjectId: {ProjectId}", ProjectId);
            _actualData = null;
            _idealData = null;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private class ChartDataPoint
    {
        public required DateTimeOffset X { get; set; }
        public required int Y { get; set; }
    }
}
