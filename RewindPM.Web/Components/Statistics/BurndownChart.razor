@using MediatR
@using RewindPM.Application.Read.Queries.Statistics
@using RewindPM.Application.Read.Queries.Projects
@using RewindPM.Application.Read.Queries.Tasks
@using RewindPM.Application.Read.DTOs

@inject IMediator Mediator
@inject ILogger<BurndownChart> Logger

@if (_isLoading)
{
    <div class="chart-loading">
        <p>チャートを読み込み中...</p>
    </div>
}
else if (_actualData != null && _actualData.Any())
{
    <div class="burndown-chart">
        <h4>Burndown Chart</h4>
        <ApexChart TItem="ChartDataPoint"
                   Title="残タスク数の推移"
                   XAxisType="XAxisType.Datetime"
                   Height="400">

            @* 理想線（予定） *@
            <ApexPointSeries TItem="ChartDataPoint"
                             Items="_idealData"
                             Name="理想線"
                             SeriesType="SeriesType.Line"
                             XValue="@(e => e.X.ToUnixTimeMilliseconds())"
                             YAggregate="@(e => e.Sum(y => y.Y))"
                             OrderBy="e=>e.X"
                             Color="#adb5bd" />

            @* 実績線 *@
            <ApexPointSeries TItem="ChartDataPoint"
                             Items="_actualData"
                             Name="実績"
                             SeriesType="SeriesType.Line"
                             XValue="@(e => e.X.ToUnixTimeMilliseconds())"
                             YAggregate="@(e => e.Sum(y => y.Y))"
                             OrderBy="e=>e.X"
                             Color="#007bff" />
        </ApexChart>
    </div>
}
else
{
    <div class="chart-error">
        <p>表示するデータがありません</p>
    </div>
}

@code {
    [Parameter]
    public required Guid ProjectId { get; set; }

    [Parameter]
    public DateTimeOffset? AsOfDate { get; set; }

    private List<ChartDataPoint>? _actualData;
    private List<ChartDataPoint>? _idealData;
    private bool _isLoading = true;

    protected override async Task OnParametersSetAsync()
    {
        await LoadChartDataAsync();
    }

    private async Task LoadChartDataAsync()
    {
        _isLoading = true;

        try
        {
            // プロジェクトの編集日一覧を取得してグラフの範囲を決定
            var editDatesQuery = new GetProjectEditDatesQuery(ProjectId, Ascending: true);
            var editDates = await Mediator.Send(editDatesQuery);

            DateTimeOffset startDate;
            DateTimeOffset endDate;

            if (editDates != null && editDates.Any())
            {
                // 最初の編集日から開始
                startDate = editDates.First();
                // リワインド時はAsOfDate、通常時は最後の編集日または現在日時
                endDate = AsOfDate ?? (editDates.Any() ? editDates.Last() : DateTimeOffset.UtcNow);
            }
            else
            {
                // フォールバック: 編集履歴がない場合は30日前から
                endDate = AsOfDate ?? DateTimeOffset.UtcNow;
                startDate = endDate.AddDays(-30);
            }

            var query = new GetProjectStatisticsTimeSeriesQuery(ProjectId, startDate, endDate);
            var timeSeriesData = await Mediator.Send(query);

            if (timeSeriesData != null && timeSeriesData.DailySnapshots.Any())
            {
                var snapshots = timeSeriesData.DailySnapshots;

                // 実績線データを作成
                _actualData = snapshots
                    .Select(s => new ChartDataPoint
                    {
                        X = s.Date,
                        Y = s.RemainingTasks
                    })
                    .ToList();

                // 理想線データを作成：開始時点でのタスクの予定終了日に基づいて計算
                // 開始時点でのタスク一覧を取得
                var tasksQuery = new GetTasksByProjectIdAtTimeQuery(ProjectId, startDate);
                var tasksAtStart = await Mediator.Send(tasksQuery);

                if (tasksAtStart != null && tasksAtStart.Any())
                {
                    var totalTasks = tasksAtStart.Count;

                    _idealData = snapshots
                        .Select(s =>
                        {
                            // この日付までに予定終了日を迎えるべきタスク数（完了予定）
                            var shouldBeCompleted = tasksAtStart.Count(t =>
                                t.ScheduledEndDate.HasValue &&
                                t.ScheduledEndDate.Value.Date <= s.Date.Date);

                            // 理想的な残タスク数
                            var idealRemaining = totalTasks - shouldBeCompleted;

                            return new ChartDataPoint
                            {
                                X = s.Date,
                                Y = idealRemaining
                            };
                        })
                        .ToList();
                }
                else
                {
                    // タスクがない場合は0のまま
                    _idealData = snapshots
                        .Select(s => new ChartDataPoint
                        {
                            X = s.Date,
                            Y = 0
                        })
                        .ToList();
                }
            }
            else
            {
                _actualData = null;
                _idealData = null;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Burndown Chartの読み込みに失敗しました。ProjectId: {ProjectId}", ProjectId);
            _actualData = null;
            _idealData = null;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private class ChartDataPoint
    {
        public DateTimeOffset X { get; set; } = DateTimeOffset.MinValue;
        public int Y { get; set; }
    }
}
