@using RewindPM.Application.Read.DTOs
@using MediatR
@using RewindPM.Application.Read.Queries.Statistics
@inject IMediator Mediator

<a href="/projects/@Project.Id" class="project-card-link">
    <div class="project-card">
        <div class="project-card-header">
            <h3 class="project-card-title">@Project.Title</h3>
        </div>
        <div class="project-card-body">
            <p class="project-card-description">@TruncatedDescription</p>
        </div>
        <div class="project-card-footer">
            @if (statistics == null)
            {
                <span class="project-card-stat text-muted">
                    <small>çµ±è¨ˆã‚’èª­ã¿è¾¼ã¿ä¸­...</small>
                </span>
            }
            else
            {
                <div class="project-card-stats">
                    <span class="stat-item">
                        ğŸ“Š @statistics.TotalTasks Tasks
                    </span>
                    <span class="stat-item">
                        âœ“ @statistics.CompletedTasks å®Œäº†
                    </span>
                    @if (statistics.InProgressTasks > 0)
                    {
                        <span class="stat-item">
                            â³ @statistics.InProgressTasks é€²è¡Œä¸­
                        </span>
                    }
                    @if (statistics.TotalTasks > 0)
                    {
                        <span class="stat-item stat-completion">
                            å®Œäº†ç‡: @statistics.CompletionRate.ToString("F1")%
                        </span>
                    }
                </div>
            }
        </div>
    </div>
</a>

@code {
    [Parameter]
    public required ProjectDto Project { get; set; }

    private ProjectStatisticsSummaryDto? statistics;

    protected override async Task OnInitializedAsync()
    {
        // çµ±è¨ˆæƒ…å ±ã‚’å–å¾—
        try
        {
            statistics = await Mediator.Send(new GetProjectStatisticsSummaryQuery(Project.Id));
        }
        catch
        {
            // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯çµ±è¨ˆã‚’è¡¨ç¤ºã—ãªã„
            statistics = null;
        }
    }

    private string TruncatedDescription
    {
        get
        {
            if (string.IsNullOrWhiteSpace(Project.Description))
                return "èª¬æ˜ãªã—";

            var lines = Project.Description.Split('\n');
            var firstTwoLines = string.Join('\n', lines.Take(2));

            if (firstTwoLines.Length > 100)
                return firstTwoLines.Substring(0, 100) + "...";

            if (lines.Length > 2)
                return firstTwoLines + "...";

            return firstTwoLines;
        }
    }
}
