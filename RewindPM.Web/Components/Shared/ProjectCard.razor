@using RewindPM.Application.Read.DTOs
@using MediatR
@using RewindPM.Application.Read.Queries.Statistics
@using Microsoft.Extensions.Logging
@inject IMediator Mediator
@inject ILogger<ProjectCard> Logger
@inject NavigationManager Navigation

<div class="project-card" @onclick="NavigateToProject">
    <div class="project-card-header">
        <h3 class="project-card-title">@Project.Title</h3>
        <button class="delete-btn" @onclick="HandleDelete" @onclick:stopPropagation="true" title="å‰Šé™¤">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
        </button>
    </div>
    <div class="project-card-body">
        <p class="project-card-description">@TruncatedDescription</p>
    </div>
    <div class="project-card-footer">
        @if (statistics == null)
        {
            <span class="project-card-stat text-muted">
                <small>çµ±è¨ˆã‚’èª­ã¿è¾¼ã¿ä¸­...</small>
            </span>
        }
        else
        {
            <div class="project-card-stats">
                <span class="stat-item">
                    ğŸ“Š @statistics.TotalTasks Tasks
                </span>
                <span class="stat-item">
                    âœ“ @statistics.CompletedTasks å®Œäº†
                </span>
                @if (statistics.InProgressTasks > 0)
                {
                    <span class="stat-item">
                        â³ @statistics.InProgressTasks é€²è¡Œä¸­
                    </span>
                }
                @if (statistics.TotalTasks > 0)
                {
                    <span class="stat-item stat-completion">
                        å®Œäº†ç‡: @statistics.CompletionRate.ToString("F1")%
                    </span>
                }
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public required ProjectDto Project { get; set; }

    [Parameter]
    public EventCallback<Guid> OnDeleteRequest { get; set; }

    private ProjectStatisticsSummaryDto? statistics;

    protected override async Task OnInitializedAsync()
    {
        // çµ±è¨ˆæƒ…å ±ã‚’å–å¾—
        try
        {
            statistics = await Mediator.Send(new GetProjectStatisticsSummaryQuery(Project.Id));
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ¼ãƒ‰ã®çµ±è¨ˆæƒ…å ±å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ProjectId: {ProjectId}", Project.Id);
            statistics = null;
        }
    }

    private string TruncatedDescription
    {
        get
        {
            if (string.IsNullOrWhiteSpace(Project.Description))
                return "èª¬æ˜ãªã—";

            var lines = Project.Description.Split('\n');
            var firstTwoLines = string.Join('\n', lines.Take(2));

            if (firstTwoLines.Length > 100)
                return firstTwoLines.Substring(0, 100) + "...";

            if (lines.Length > 2)
                return firstTwoLines + "...";

            return firstTwoLines;
        }
    }

    private async Task HandleDelete()
    {
        await OnDeleteRequest.InvokeAsync(Project.Id);
    }

    private void NavigateToProject()
    {
        Navigation.NavigateTo($"/projects/{Project.Id}");
    }
}
