@using RewindPM.Application.Read.DTOs
@using MediatR
@using RewindPM.Application.Read.Queries.Statistics
@using Microsoft.Extensions.Logging
@inject IMediator Mediator
@inject ILogger<ProjectCard> Logger
@inject NavigationManager Navigation

<div class="project-card" @onclick="NavigateToProject" @onkeydown="HandleKeyDown" tabindex="0" role="button" aria-label="„Éó„É≠„Ç∏„Çß„ÇØ„Éà @Project.Title „ÇíÈñã„Åè">
    <div class="project-card-header">
        <h3 class="project-card-title">@Project.Title</h3>
        <button class="delete-btn" @onclick="HandleDelete" @onclick:stopPropagation="true" aria-label="„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂâäÈô§" title="ÂâäÈô§">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
        </button>
    </div>
    <div class="project-card-body">
        <p class="project-card-description">@TruncatedDescription</p>
    </div>
    <div class="project-card-footer">
        @if (statistics == null)
        {
            <span class="project-card-stat text-muted">
                <small>Áµ±Ë®à„ÇíË™≠„ÅøËæº„Åø‰∏≠...</small>
            </span>
        }
        else
        {
            <div class="project-card-stats">
                <span class="stat-item">
                    üìä @statistics.TotalTasks Tasks
                </span>
                <span class="stat-item">
                    ‚úì @statistics.CompletedTasks ÂÆå‰∫Ü
                </span>
                @if (statistics.InProgressTasks > 0)
                {
                    <span class="stat-item">
                        ‚è≥ @statistics.InProgressTasks ÈÄ≤Ë°å‰∏≠
                    </span>
                }
                @if (statistics.TotalTasks > 0)
                {
                    <span class="stat-item stat-completion">
                        ÂÆå‰∫ÜÁéá: @statistics.CompletionRate.ToString("F1")%
                    </span>
                }
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public required ProjectDto Project { get; set; }

    [Parameter]
    public EventCallback<Guid> OnDeleteRequest { get; set; }

    private ProjectStatisticsSummaryDto? statistics;

    protected override async Task OnInitializedAsync()
    {
        // Áµ±Ë®àÊÉÖÂ†±„ÇíÂèñÂæó
        try
        {
            statistics = await Mediator.Send(new GetProjectStatisticsSummaryQuery(Project.Id));
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„Éº„Éâ„ÅÆÁµ±Ë®àÊÉÖÂ†±ÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇProjectId: {ProjectId}", Project.Id);
            statistics = null;
        }
    }

    private string TruncatedDescription
    {
        get
        {
            if (string.IsNullOrWhiteSpace(Project.Description))
                return "Ë™¨Êòé„Å™„Åó";

            var lines = Project.Description.Split('\n');
            var firstTwoLines = string.Join('\n', lines.Take(2));

            if (firstTwoLines.Length > 100)
                return firstTwoLines.Substring(0, 100) + "...";

            if (lines.Length > 2)
                return firstTwoLines + "...";

            return firstTwoLines;
        }
    }

    private async Task HandleDelete()
    {
        await OnDeleteRequest.InvokeAsync(Project.Id);
    }

    private void NavigateToProject()
    {
        Navigation.NavigateTo($"/projects/{Project.Id}");
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" || e.Key == " ")
        {
            NavigateToProject();
        }
    }
}
