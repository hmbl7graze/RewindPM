@using MediatR
@using RewindPM.Application.Write.Commands.Tasks
@using RewindPM.Application.Read.DTOs
@using TaskStatus = RewindPM.Domain.ValueObjects.TaskStatus
@using RewindPM.Web.Components.Shared
@using Microsoft.Extensions.Logging
@using FluentValidation
@using RewindPM.Domain.Common
@inject IMediator Mediator
@inject ILogger<TaskFormModal> Logger

<Modal Title="@ModalTitle" IsVisible="IsVisible" IsVisibleChanged="HandleModalVisibilityChanged" Size="ModalSize.ExtraLarge">
    <div class="task-form-layout">
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger mb-3">@errorMessage</div>
        }

        <!-- Title Section (Top) -->
        <div class="task-title-section">
            @if (IsEditMode && ExistingTask != null)
            {
               @*  <div class="task-id-display">Task #@ExistingTask.TaskNumber</div> *@
            }
            <label class="form-label text-muted small fw-bold">タスク名</label>
            <input type="text"
                   class="form-control task-title-input @(titleError != null ? "is-invalid" : "")"
                   @bind="title"
                   maxlength="200"
                   placeholder="タスク名"
                   disabled="@IsReadOnly" />
            @if (titleError != null)
            {
                <div class="invalid-feedback d-block">@titleError</div>
            }
        </div>

        <!-- Split Content -->
        <div class="task-content-wrapper">
            <!-- Left: Description -->
            <div class="task-main-column">
                <div class="description-container">
                    <label class="form-label text-muted small fw-bold">説明</label>
                    <textarea class="form-control description-textarea"
                              @bind="description"
                              maxlength="5000"
                              placeholder="タスクの詳細な説明を入力してください..."
                              disabled="@IsReadOnly"></textarea>
                </div>
            </div>

            <!-- Right: Metadata Sidebar -->
            <div class="task-sidebar-column">
                <!-- Status -->
                <div class="sidebar-section">
                    <h5>ステータス</h5>
                    <select class="form-select text-sm" @bind="status" disabled="@IsReadOnly">
                        <option value="@TaskStatus.Todo">TODO</option>
                        <option value="@TaskStatus.InProgress">進行中</option>
                        <option value="@TaskStatus.InReview">レビュー中</option>
                        <option value="@TaskStatus.Done">完了</option>
                    </select>
                </div>

                <!-- Schedule -->
                <div class="sidebar-section">
                    <h5>予定</h5>
                    <div class="d-flex gap-2">
                        <div class="mb-2 flex-fill">
                            <label class="form-label small text-muted">予定開始日</label>
                            <input type="date" class="form-control form-control-sm @(scheduledDateError != null ? "is-invalid" : "")"
                                   @bind="scheduledStartDate" disabled="@IsReadOnly" />
                        </div>
                        <div class="mb-2 flex-fill">
                            <label class="form-label small text-muted">予定終了日</label>
                            <input type="date" class="form-control form-control-sm @(scheduledDateError != null ? "is-invalid" : "")"
                                   @bind="scheduledEndDate" disabled="@IsReadOnly" />
                        </div>
                    </div>
                    @if (scheduledDateError != null)
                    {
                        <div class="text-danger small">@scheduledDateError</div>
                    }
                    <div>
                        <label class="form-label small text-muted">予定工数 (h)</label>
                        <input type="number" class="form-control form-control-sm @(estimatedHoursError != null ? "is-invalid" : "")"
                               @bind="estimatedHours" min="1" disabled="@IsReadOnly" />
                         @if (estimatedHoursError != null)
                        {
                            <div class="invalid-feedback d-block">@estimatedHoursError</div>
                        }
                    </div>
                </div>

                <!-- Actuals -->
                <div class="sidebar-section">
                    <h5>実績</h5>
                    <div class="d-flex gap-2">
                        <div class="mb-2 flex-fill">
                            <label class="form-label small text-muted">実績開始日</label>
                            <input type="date" class="form-control form-control-sm @(actualDateError != null ? "is-invalid" : "")"
                                   @bind="actualStartDate" disabled="@IsReadOnly" />
                        </div>
                        <div class="mb-2 flex-fill">
                            <label class="form-label small text-muted">実績終了日</label>
                            <input type="date" class="form-control form-control-sm @(actualDateError != null ? "is-invalid" : "")"
                                   @bind="actualEndDate" disabled="@IsReadOnly" />
                        </div>
                    </div>
                    @if (actualDateError != null)
                    {
                        <div class="text-danger small">@actualDateError</div>
                    }
                     <div>
                        <label class="form-label small text-muted">実績工数 (h)</label>
                        <input type="number" class="form-control form-control-sm @(actualHoursError != null ? "is-invalid" : "")"
                               @bind="actualHours" min="1" disabled="@IsReadOnly" />
                         @if (actualHoursError != null)
                        {
                            <div class="invalid-feedback d-block">@actualHoursError</div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer Actions -->
        <div class="modal-footer-actions">
            @if (IsEditMode && !IsReadOnly)
            {
                <button class="btn btn-outline-danger me-auto" @onclick="HandleDelete">削除</button>
            }
            
            <button class="btn btn-outline-secondary" @onclick="HandleCancel">@(IsReadOnly ? "閉じる" : "キャンセル")</button>
            
            @if (!IsReadOnly)
            {
                @if (isSaving)
                {
                    <button class="btn btn-primary" disabled>
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        保存中...
                    </button>
                }
                else
                {
                    <button class="btn btn-success" @onclick="HandleSave">保存</button>
                }
            }
        </div>
    </div>
</Modal>

@code {
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }

    [Parameter]
    public Guid ProjectId { get; set; }

    [Parameter]
    public TaskDto? ExistingTask { get; set; }

    [Parameter]
    public EventCallback OnSuccess { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    [Parameter]
    public bool IsReadOnly { get; set; } = false;

    private bool IsEditMode => ExistingTask != null;
    private string ModalTitle => IsReadOnly ? "タスク詳細（読み取り専用）" : (IsEditMode ? "タスク編集" : "タスク作成");

    private string title = string.Empty;
    private string description = string.Empty;
    private TaskStatus status = TaskStatus.Todo;
    private DateTimeOffset? scheduledStartDate;
    private DateTimeOffset? scheduledEndDate;
    private int? estimatedHours;
    private DateTimeOffset? actualStartDate;
    private DateTimeOffset? actualEndDate;
    private int? actualHours;

    private bool isSaving = false;
    private bool deleteConfirmation = false;
    private string? errorMessage;
    private string? titleError;
    private string? scheduledDateError;
    private string? estimatedHoursError;
    private string? actualDateError;
    private string? actualHoursError;

    protected override void OnParametersSet()
    {
        if (ExistingTask != null)
        {
            LoadExistingTask();
        }
        else
        {
            ResetForm();
        }
    }

    private void LoadExistingTask()
    {
        if (ExistingTask == null) return;

        title = ExistingTask.Title;
        description = ExistingTask.Description;
        status = ExistingTask.Status;
        scheduledStartDate = ExistingTask.ScheduledStartDate;
        scheduledEndDate = ExistingTask.ScheduledEndDate;
        estimatedHours = ExistingTask.EstimatedHours;
        actualStartDate = ExistingTask.ActualStartDate;
        actualEndDate = ExistingTask.ActualEndDate;
        actualHours = ExistingTask.ActualHours;
    }

    private void ResetForm()
    {
        title = string.Empty;
        description = string.Empty;
        status = TaskStatus.Todo;
        scheduledStartDate = null;
        scheduledEndDate = null;
        estimatedHours = null;
        actualStartDate = null;
        actualEndDate = null;
        actualHours = null;
        deleteConfirmation = false;
        ClearErrors();
    }

    private void ClearErrors()
    {
        errorMessage = null;
        titleError = null;
        scheduledDateError = null;
        estimatedHoursError = null;
        actualDateError = null;
        actualHoursError = null;
        deleteConfirmation = false;
    }

    private bool ValidateForm()
    {
        ClearErrors();
        bool isValid = true;

        // タスク名の検証
        if (string.IsNullOrWhiteSpace(title))
        {
            titleError = "タスク名は必須です。";
            isValid = false;
        }
        else if (title.Length > 200)
        {
            titleError = "タスク名は200文字以内で入力してください。";
            isValid = false;
        }

        // 予定期間の検証
        // 予定期間を変更する場合は、開始日と終了日の両方が必須（工数はオプショナル）
        var hasAnyScheduledDate = scheduledStartDate.HasValue || scheduledEndDate.HasValue;
        var hasBothScheduledDates = scheduledStartDate.HasValue && scheduledEndDate.HasValue;

        if (IsEditMode && hasAnyScheduledDate && !hasBothScheduledDates)
        {
            // 編集モードで開始日または終了日の一方のみが入力されている場合
            if (!scheduledStartDate.HasValue)
            {
                scheduledDateError = "予定期間を変更する場合は、開始日と終了日の両方を入力してください。";
                isValid = false;
            }
            else if (!scheduledEndDate.HasValue)
            {
                scheduledDateError = "予定期間を変更する場合は、開始日と終了日の両方を入力してください。";
                isValid = false;
            }
        }

        if (scheduledStartDate.HasValue && scheduledEndDate.HasValue)
        {
            if (scheduledEndDate <= scheduledStartDate)
            {
                scheduledDateError = "予定終了日は予定開始日より後の日付を指定してください。";
                isValid = false;
            }
        }

        // 予定工数の検証
        if (estimatedHours.HasValue && estimatedHours <= 0)
        {
            estimatedHoursError = "見積工数は正の数でなければなりません。";
            isValid = false;
        }

        // 実績期間の検証
        if (actualStartDate.HasValue && actualEndDate.HasValue)
        {
            if (actualEndDate <= actualStartDate)
            {
                actualDateError = "実績終了日は実績開始日より後の日付を指定してください。";
                isValid = false;
            }
        }

        // 実績工数の検証
        if (actualHours.HasValue && actualHours <= 0)
        {
            actualHoursError = "実績工数は正の数でなければなりません。";
            isValid = false;
        }

        return isValid;
    }

    private async Task HandleSave()
    {
        if (!ValidateForm())
        {
            return;
        }

        isSaving = true;
        errorMessage = null;

        try
        {
            if (IsEditMode)
            {
                await UpdateTask();
            }
            else
            {
                await CreateTask();
            }

            await OnSuccess.InvokeAsync();
            await CloseModal();
        }
        catch (ValidationException vex)
        {
            // FluentValidationのバリデーションエラー
            Logger.LogWarning(vex, "タスク保存時にバリデーションエラーが発生しました。TaskId: {TaskId}, ProjectId: {ProjectId}", ExistingTask?.Id, ProjectId);

            // 複数のエラーメッセージを結合して表示
            var errors = string.Join("\n", vex.Errors.Select(e => e.ErrorMessage));
            errorMessage = $"入力内容に誤りがあります:\n{errors}";
        }
        catch (InvalidOperationException ioex)
        {
            // タスクが見つからない場合など
            Logger.LogError(ioex, "タスク保存中に操作エラーが発生しました。TaskId: {TaskId}, ProjectId: {ProjectId}", ExistingTask?.Id, ProjectId);
            errorMessage = ioex.Message;
        }
        catch (DomainException dex)
        {
            // ドメイン層のビジネスルール違反
            Logger.LogError(dex, "タスク保存中にドメインエラーが発生しました。TaskId: {TaskId}, ProjectId: {ProjectId}", ExistingTask?.Id, ProjectId);
            errorMessage = $"ビジネスルールの違反:\n{dex.Message}";
        }
        catch (ArgumentException aex)
        {
            // ValueObjectのバリデーションエラー
            Logger.LogError(aex, "タスク保存中に引数エラーが発生しました。TaskId: {TaskId}, ProjectId: {ProjectId}", ExistingTask?.Id, ProjectId);
            errorMessage = aex.Message;
        }
        catch (Exception ex)
        {
            // その他の予期しないエラー
            Logger.LogError(ex, "タスク保存中に予期しないエラーが発生しました。TaskId: {TaskId}, ProjectId: {ProjectId}", ExistingTask?.Id, ProjectId);
            errorMessage = "タスクの保存に失敗しました。しばらく時間をおいてから再度お試しください。";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task CreateTask()
    {
        var command = new CreateTaskCommand(
            Id: Guid.NewGuid(),
            ProjectId: ProjectId,
            Title: title,
            Description: description,
            ScheduledStartDate: scheduledStartDate,
            ScheduledEndDate: scheduledEndDate,
            EstimatedHours: estimatedHours,
            ActualStartDate: actualStartDate,
            ActualEndDate: actualEndDate,
            ActualHours: actualHours,
            CreatedBy: "admin"
        );

        await Mediator.Send(command);

        // ステータスがTODO以外の場合、ステータス変更コマンドを送信
        if (status != TaskStatus.Todo)
        {
            var changeStatusCommand = new ChangeTaskStatusCommand(
                TaskId: command.Id,
                NewStatus: status,
                ChangedBy: "admin"
            );
            await Mediator.Send(changeStatusCommand);
        }
    }

    private async Task UpdateTask()
    {
        if (ExistingTask == null) return;

        // タイトルまたは説明が変更された場合
        if (title != ExistingTask.Title || description != ExistingTask.Description)
        {
            var updateCommand = new UpdateTaskCommand(
                TaskId: ExistingTask.Id,
                Title: title,
                Description: description,
                UpdatedBy: "admin"
            );
            await Mediator.Send(updateCommand);
        }

        // ステータスが変更された場合
        if (status != ExistingTask.Status)
        {
            var changeStatusCommand = new ChangeTaskStatusCommand(
                TaskId: ExistingTask.Id,
                NewStatus: status,
                ChangedBy: "admin"
            );
            await Mediator.Send(changeStatusCommand);
        }

        // 予定期間が変更された場合（開始日と終了日の両方が設定されている場合のみ）
        if (scheduledStartDate.HasValue && scheduledEndDate.HasValue)
        {
            if (scheduledStartDate != ExistingTask.ScheduledStartDate ||
                scheduledEndDate != ExistingTask.ScheduledEndDate ||
                estimatedHours != ExistingTask.EstimatedHours)
            {
                var changeScheduleCommand = new ChangeTaskScheduleCommand(
                    TaskId: ExistingTask.Id,
                    ScheduledStartDate: scheduledStartDate.Value,
                    ScheduledEndDate: scheduledEndDate.Value,
                    EstimatedHours: estimatedHours,
                    ChangedBy: "admin"
                );
                await Mediator.Send(changeScheduleCommand);
            }
        }

        // 実績期間が変更された場合
        if (actualStartDate != ExistingTask.ActualStartDate ||
            actualEndDate != ExistingTask.ActualEndDate ||
            actualHours != ExistingTask.ActualHours)
        {
            var changeActualCommand = new ChangeTaskActualPeriodCommand(
                TaskId: ExistingTask.Id,
                ActualStartDate: actualStartDate,
                ActualEndDate: actualEndDate,
                ActualHours: actualHours,
                ChangedBy: "admin"
            );
            await Mediator.Send(changeActualCommand);
        }
    }

    private async Task HandleDelete()
    {
        if (ExistingTask == null) return;

        // 確認メッセージを表示
        // TODO: より洗練された確認ダイアログを実装する場合はJSInteropを使用
        errorMessage = "本当にこのタスクを削除しますか？もう一度削除ボタンをクリックすると削除されます。";

        // 簡易的な実装: 2回クリックで削除
        if (deleteConfirmation)
        {
            isSaving = true;
            errorMessage = null;

            try
            {
                // TODO: 認証システム実装後、実際のログインユーザーIDを使用すること
                var command = new DeleteTaskCommand(
                    TaskId: ExistingTask.Id,
                    DeletedBy: "system"
                );

                await Mediator.Send(command);
                await OnSuccess.InvokeAsync();
                await CloseModal();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "タスク削除中にエラーが発生しました。TaskId: {TaskId}", ExistingTask.Id);
                errorMessage = "タスクの削除に失敗しました。しばらく時間をおいてから再度お試しください。";
                deleteConfirmation = false;
                isSaving = false;
            }
        }
        else
        {
            deleteConfirmation = true;
        }
    }

    private async Task HandleCancel()
    {
        await CloseModal();
        await OnCancel.InvokeAsync();
    }

    private async Task CloseModal()
    {
        ResetForm();
        await IsVisibleChanged.InvokeAsync(false);
    }

    private void HandleModalVisibilityChanged(bool isVisible)
    {
        IsVisible = isVisible;
        _ = IsVisibleChanged.InvokeAsync(isVisible);
    }
}
