@page "/projects/{id:guid}"
@rendermode InteractiveServer
@using MediatR
@using RewindPM.Application.Read.Queries.Projects
@using RewindPM.Application.Read.Queries.Tasks
@using RewindPM.Application.Read.DTOs
@using RewindPM.Application.Write.Commands.Tasks
@using RewindPM.Web.Components.Pages.Tasks
@using RewindPM.Web.Components.Tasks
@using RewindPM.Web.Components.Shared
@using RewindPM.Web.Components.Statistics
@using TaskStatus = RewindPM.Domain.ValueObjects.TaskStatus
@using Microsoft.AspNetCore.WebUtilities
@inject IMediator Mediator
@inject NavigationManager Navigation
@inject ILogger<Detail> Logger

<PageTitle>@(project?.Title ?? "プロジェクト詳細") - RewindPM</PageTitle>

@if (isLoading)
{
    <div class="loading-state">
        <p><em>読み込み中...</em></p>
    </div>
}
else if (project == null)
{
    <div class="alert alert-danger">プロジェクトが見つかりません。</div>
    <a href="/projects" class="btn btn-secondary">プロジェクト一覧に戻る</a>
}
else
{
    <!-- ヘッダー部 -->
    <div class="project-detail-header">
        <div class="header-left">
            <a href="/projects" class="back-link">← プロジェクト一覧に戻る</a>
        </div>
        <div class="header-center">
            <h1 class="project-title">
                @project.Title
            </h1>
        </div>
        <div class="header-right">
            <button class="btn btn-outline-secondary" @onclick="ShowInfoModal">
                情報
            </button>
            <button class="btn btn-primary" @onclick="ToggleRewindMode">
                過去に戻る
            </button>
        </div>
    </div>



    <!-- タイムラインコントロール(リワインド機能) - 振り返りモード時のみ表示 -->
    @if (_isRewindMode)
    {
        <div class="rewind-panel">
            <TimelineControl
                CurrentDate="_currentViewDate"
                EditDates="_editDates"
                OnDateChanged="HandleDateChanged" />
        </div>
    }

    <!-- タスクビュー表示エリア -->
    <div class="tasks-section">
        <div class="view-header">
            <div class="view-tabs">
                <button class="view-tab @(_viewType == "Kanban" ? "active" : "")" @onclick='() => ToggleView("Kanban")'>カンバン</button>
                <button class="view-tab @(_viewType == "Gantt" ? "active" : "")" @onclick='() => ToggleView("Gantt")'>ガントチャート</button>
                <button class="view-tab @(_viewType == "Statistics" ? "active" : "")" @onclick='() => ToggleView("Statistics")'>統計</button>
            </div>
            <div class="view-actions">
                <button class="btn btn-success" @onclick="ShowCreateTaskModal" disabled="@_isViewingPast">+ 新規タスク</button>
            </div>
        </div>

        <div class="view-container">
            @if (_viewType == "Gantt")
            {
                @if (isLoadingTasks)
                {
                    <div class="loading-overlay">
                        <p><em>タスクを読み込み中...</em></p>
                    </div>
                }
                else
                {
                    <GanttChart Tasks="@(tasks ?? new List<TaskDto>())"
                                OnTaskClick="ShowTaskDetailModal"
                                OnBarResize="HandleBarResize"
                                ViewDate="_currentViewDate"
                                IsReadOnly="_isViewingPast" />
                }
            }
            else if (_viewType == "Statistics")
            {
                <ProjectStatisticsDashboard @key="@(_isRewindMode ? _currentViewDate?.ToString() : "latest")" ProjectId="@Id" AsOfDate="@(_isRewindMode ? _currentViewDate : null)" />
            }
            else
            {
                @if (isLoadingTasks)
                {
                    <div class="loading-overlay">
                        <p><em>タスクを読み込み中...</em></p>
                    </div>
                }
                else
                {
                    <KanbanBoard Tasks="@(tasks ?? new List<TaskDto>())"
                                 OnTaskClick="ShowTaskDetailModal"
                                 OnTaskStatusChanged="HandleTaskStatusChanged"
                                 IsReadOnly="_isViewingPast" />
                }
            }
        </div>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger mt-3">@errorMessage</div>
    }

    <!-- タスク作成・編集モーダル -->
    <TaskFormModal IsVisible="showTaskModal"
                   IsVisibleChanged="HandleTaskModalVisibleChanged"
                   ProjectId="@Id"
                   ExistingTask="@selectedTask"
                   OnSuccess="HandleTaskModalSuccess"
                   OnCancel="HandleTaskModalCancel"
                   IsReadOnly="_isViewingPast" />

    <!-- プロジェクト情報モーダル -->
    <ProjectInfoModal IsVisible="showInfoModal"
                      IsVisibleChanged="HandleProjectInfoModalVisibleChanged"
                      ProjectId="@Id"
                      ProjectTitle="@project.Title"
                      ProjectDescription="@project.Description"
                      OnSuccess="HandleProjectInfoUpdate" />
}

@code {
    private const string DefaultUserId = "system";
    private const string GanttViewType = "Gantt";
    private const string KanbanViewType = "Kanban";
    private const string StatisticsViewType = "Statistics";

    [Parameter]
    public Guid Id { get; set; }

    // データ状態
    private ProjectDto? project;
    private List<TaskDto>? tasks;

    // UI状態
    private bool isLoading = true;
    private bool isLoadingTasks = true;
    private string? errorMessage;
    private bool showTaskModal = false;
    private bool showInfoModal = false;
    private TaskDto? selectedTask = null;

    // ビュー状態
    private string _viewType = GanttViewType;

    // リワインド機能用の状態
    private DateTimeOffset? _currentViewDate = null; // null = 最新
    private List<DateTimeOffset> _editDates = new();
    private bool _isViewingPast => _currentViewDate.HasValue;
    private bool _isRewindMode = false;

    // ビュー切り替え用の状態
    private Guid? _previousId = null; // 前回のIdパラメータ値
    private string? _previousTabQuery = null; // 前回のtabクエリパラメータ値

    private void ToggleView(string viewType)
    {
        _viewType = viewType;

        // ビュー切り替え時にモーダルを閉じる
        showTaskModal = false;
        selectedTask = null;

        // URLクエリパラメータを更新
        var uri = Navigation.GetUriWithQueryParameter("tab", viewType.ToLower());
        Navigation.NavigateTo(uri, false);

        // 前回のクエリパラメータを更新（OnParametersSetでの二重設定を防ぐ）
        _previousTabQuery = viewType.ToLower();
    }

    private async Task HandleTaskStatusChanged((TaskDto task, TaskStatus newStatus) changeData)
    {
        if (_isViewingPast)
            return;

        try
        {
            await UpdateTaskStatus(changeData);
            await ReloadTaskData();
        }
        catch (Exception ex)
        {
            LogAndDisplayError(ex, "タスクのステータス更新に失敗しました", changeData.task.Id);
        }
    }

    private async Task UpdateTaskStatus((TaskDto task, TaskStatus newStatus) changeData)
    {
        var command = new ChangeTaskStatusCommand(
            TaskId: changeData.task.Id,
            NewStatus: changeData.newStatus,
            ChangedBy: DefaultUserId
        );

        await Mediator.Send(command);
    }

    private async Task ReloadTaskData()
    {
        await LoadTasks();
        await LoadEditDates();
        StateHasChanged();
    }

    private void LogAndDisplayError(Exception ex, string message, Guid? taskId = null)
    {
        if (taskId.HasValue)
        {
            Logger.LogError(ex, "{Message} for task {TaskId}", message, taskId.Value);
        }
        else
        {
            Logger.LogError(ex, message);
        }
        errorMessage = "操作に失敗しました。もう一度お試しください。";
    }

    protected override void OnParametersSet()
    {
        // URLクエリパラメータからタブの状態を読み取る
        var uri = new Uri(Navigation.Uri);
        var queryParams = QueryHelpers.ParseQuery(uri.Query);

        // StringValuesから最初の値を明示的に取得（複数値の場合の予期しない動作を防ぐ）
        var currentTabQuery = queryParams.TryGetValue("tab", out var tabValue)
            ? tabValue.FirstOrDefault()?.ToLower()
            : null;

        // Idパラメータが変更された場合、または tabクエリパラメータが変更された場合のみタブ状態を更新
        var isIdChanged = _previousId != Id;
        var isTabQueryChanged = _previousTabQuery != currentTabQuery;

        if (isIdChanged || isTabQueryChanged)
        {
            _previousId = Id;
            _previousTabQuery = currentTabQuery;

            // クエリパラメータに基づいてタブ状態を設定（nullまたは空の場合はデフォルト）
            _viewType = currentTabQuery switch
            {
                "gantt" => "Gantt",
                "kanban" => "Kanban",
                "statistics" => "Statistics",
                null or "" => "Kanban", // デフォルト
                _ => "Kanban" // 無効な値の場合もデフォルト
            };
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadProject();
        await LoadEditDates();
        await LoadTasks();
    }

    /// <summary>
    /// 編集日一覧を取得
    /// </summary>
    private async Task LoadEditDates()
    {
        try
        {
            var query = new GetProjectEditDatesQuery(Id, Ascending: false);
            _editDates = await Mediator.Send(query);
        }
        catch (Exception ex)
        {
            errorMessage = $"編集日一覧の読み込みに失敗しました: {ex.Message}";
            _editDates = new List<DateTimeOffset>();
        }
    }

    private async Task LoadProject()
    {
        try
        {
            var query = new GetProjectByIdQuery(Id);
            project = await Mediator.Send(query);
        }
        catch (Exception ex)
        {
            errorMessage = $"プロジェクトの読み込みに失敗しました: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadTasks()
    {
        try
        {
            isLoadingTasks = true;
            StateHasChanged(); // ローディング表示を即座に反映
            tasks = _isViewingPast 
                ? await LoadTasksAtTime(_currentViewDate!.Value)
                : await LoadLatestTasks();
        }
        catch (Exception ex)
        {
            HandleTaskLoadError(ex);
        }
        finally
        {
            isLoadingTasks = false;
            StateHasChanged(); // ローディング解除を確実に反映
        }
    }

    private async Task<List<TaskDto>> LoadTasksAtTime(DateTimeOffset date)
    {
        var query = new GetTasksByProjectIdAtTimeQuery(Id, date);
        return await Mediator.Send(query);
    }

    private async Task<List<TaskDto>> LoadLatestTasks()
    {
        var query = new GetTasksByProjectIdQuery(Id);
        return await Mediator.Send(query);
    }

    private void HandleTaskLoadError(Exception ex)
    {
        errorMessage = $"タスクの読み込みに失敗しました: {ex.Message}";
        tasks = new List<TaskDto>();
    }

    private void ShowCreateTaskModal()
    {
        if (_isViewingPast)
        {
            errorMessage = "過去の状態を表示中のため、タスクを作成できません。";
            return;
        }

        selectedTask = null;
        showTaskModal = true;
    }

    private void ShowTaskDetailModal(TaskDto task)
    {
        selectedTask = task;
        showTaskModal = true;
    }

    private async Task HandleTaskModalSuccess()
    {
        CloseTaskModal();
        await ReloadTaskData();
    }

    private void HandleTaskModalVisibleChanged(bool isVisible)
    {
        showTaskModal = isVisible;
    }

    private void HandleTaskModalCancel()
    {
        CloseTaskModal();
    }

    private void CloseTaskModal()
    {
        showTaskModal = false;
        selectedTask = null;
    }

    private void ShowInfoModal()
    {
        showInfoModal = true;
    }

    private async Task HandleProjectInfoUpdate()
    {
        // プロジェクト情報を再読み込み
        await LoadProject();
        StateHasChanged();
    }

    private void HandleProjectInfoModalVisibleChanged(bool isVisible)
    {
        showInfoModal = isVisible;
    }

    /// <summary>
    /// タイムラインコントロールで日付が変更された際の処理
    /// </summary>
    private async Task HandleDateChanged(DateTimeOffset? newDate)
    {
        _currentViewDate = newDate;
        await LoadTasks();
        StateHasChanged();
    }

    private async Task HandleBarResize((Guid taskId, string barType, DateTimeOffset newStartDate, DateTimeOffset newEndDate) resizeData)
    {
        if (_isViewingPast)
        {
            errorMessage = "過去の状態を表示中のため、編集できません。";
            return;
        }

        try
        {
            var task = FindTaskById(resizeData.taskId);
            if (task == null) return;

            await UpdateTaskPeriod(task, resizeData);
            await ReloadTaskData();
        }
        catch (Exception ex)
        {
            LogAndDisplayError(ex, "タスクの期間更新に失敗しました", resizeData.taskId);
        }
    }

    private TaskDto? FindTaskById(Guid taskId)
    {
        return tasks?.FirstOrDefault(t => t.Id == taskId);
    }

    private async Task UpdateTaskPeriod(TaskDto task, (Guid taskId, string barType, DateTimeOffset newStartDate, DateTimeOffset newEndDate) resizeData)
    {
        if (resizeData.barType == "scheduled")
        {
            await UpdateScheduledPeriod(task, resizeData.newStartDate, resizeData.newEndDate);
        }
        else if (resizeData.barType == "actual")
        {
            await UpdateActualPeriod(task, resizeData.newStartDate, resizeData.newEndDate);
        }
    }

    private async Task UpdateScheduledPeriod(TaskDto task, DateTimeOffset newStartDate, DateTimeOffset newEndDate)
    {
        var command = new ChangeTaskScheduleCommand(
            TaskId: task.Id,
            ScheduledStartDate: newStartDate,
            ScheduledEndDate: newEndDate,
            EstimatedHours: task.EstimatedHours ?? 0,
            ChangedBy: DefaultUserId
        );
        await Mediator.Send(command);
    }

    private async Task UpdateActualPeriod(TaskDto task, DateTimeOffset newStartDate, DateTimeOffset newEndDate)
    {
        var command = new ChangeTaskActualPeriodCommand(
            TaskId: task.Id,
            ActualStartDate: newStartDate,
            ActualEndDate: newEndDate,
            ActualHours: task.ActualHours,
            ChangedBy: DefaultUserId
        );
        await Mediator.Send(command);
    }

    private async Task ToggleRewindMode()
    {
        _isRewindMode = !_isRewindMode;
        
        if (ShouldReturnToLatestState())
        {
            await ReturnToLatestState();
        }
    }

    private bool ShouldReturnToLatestState()
    {
        return !_isRewindMode && _isViewingPast;
    }

    private async Task ReturnToLatestState()
    {
        _currentViewDate = null;
        await LoadTasks();
    }
}
