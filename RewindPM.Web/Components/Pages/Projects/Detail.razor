@page "/projects/{id:guid}"
@rendermode InteractiveServer
@using MediatR
@using RewindPM.Application.Read.Queries.Projects
@using RewindPM.Application.Read.Queries.Tasks
@using RewindPM.Application.Read.DTOs
@using RewindPM.Application.Write.Commands.Tasks
@using RewindPM.Web.Components.Pages.Tasks
@using RewindPM.Web.Components.Tasks
@using RewindPM.Web.Components.Shared
@inject IMediator Mediator
@inject NavigationManager Navigation

<PageTitle>@(project?.Title ?? "プロジェクト詳細") - RewindPM</PageTitle>

@if (isLoading)
{
    <div class="loading-state">
        <p><em>読み込み中...</em></p>
    </div>
}
else if (project == null)
{
    <div class="alert alert-danger">プロジェクトが見つかりません。</div>
    <a href="/projects" class="btn btn-secondary">プロジェクト一覧に戻る</a>
}
else
{
    <!-- ヘッダー部 -->
    <div class="project-detail-header">
        <div class="header-left">
            <a href="/projects" class="back-link">← Back to Projects</a>
        </div>
        <div class="header-center">
            <h1 class="project-title">
                @project.Title
                <a href="/projects/@Id/edit" class="btn-icon header-edit-btn" title="Edit Project">
                    Edit
                </a>
            </h1>
        </div>
        <div class="header-right">
            <button class="btn @(_isRetrospectiveMode ? "btn-primary" : "btn-outline-secondary")" @onclick="ToggleRetrospectiveMode">
                Retrospective
            </button>
        </div>
    </div>

    <!-- プロジェクト情報表示 -->
    <div class="project-info">
        @if (!string.IsNullOrWhiteSpace(project.Description))
        {
            <div class="project-description">
                <strong>Description:</strong>
                <p>@project.Description</p>
            </div>
        }
    </div>

    <!-- タイムラインコントロール（リワインド機能） - 振り返りモード時のみ表示 -->
    @if (_isRetrospectiveMode)
    {
        <div class="retrospective-panel">
            <TimelineControl
                CurrentDate="_currentViewDate"
                EditDates="_editDates"
                OnDateChanged="HandleDateChanged" />
        </div>
    }

    <!-- 過去表示中の警告バナー -->
    @if (_isViewingPast)
    {
        <div class="alert alert-warning past-view-banner">
            <strong>過去の状態を表示中です。</strong>
            編集はできません。最新状態に戻るには「最新に戻る」ボタンをクリックしてください。
        </div>
    }

    <!-- ガントチャート表示エリア -->
    <div class="tasks-section">
        <div class="view-header">
            <div class="view-tabs">
                <button class="view-tab active">Gantt Chart</button>
                <button class="view-tab disabled" title="Coming Soon">Kanban</button>
            </div>
            <div class="view-actions">
                <button class="btn btn-success" @onclick="ShowCreateTaskModal" disabled="@_isViewingPast">Add Task</button>
            </div>
        </div>

        @if (isLoadingTasks)
        {
            <p><em>タスクを読み込み中...</em></p>
        }
        else
        {
            <GanttChart Tasks="@(tasks ?? new List<TaskDto>())"
                        OnTaskClick="ShowTaskDetailModal"
                        OnBarResize="HandleBarResize"
                        ViewDate="_currentViewDate"
                        IsReadOnly="_isViewingPast" />
        }
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger mt-3">@errorMessage</div>
    }

    <!-- タスク作成・編集モーダル -->
    <TaskFormModal @bind-IsVisible="showTaskModal"
                   ProjectId="@Id"
                   ExistingTask="@selectedTask"
                   OnSuccess="HandleTaskModalSuccess"
                   OnCancel="HandleTaskModalCancel"
                   IsReadOnly="_isViewingPast" />
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private ProjectDto? project;
    private List<TaskDto>? tasks;
    private bool isLoading = true;
    private bool isLoadingTasks = true;
    private string? errorMessage;
    private bool showTaskModal = false;
    private TaskDto? selectedTask = null;

    // リワインド機能用の状態
    private DateTime? _currentViewDate = null; // null = 最新
    private List<DateTime> _editDates = new();
    private bool _isViewingPast => _currentViewDate.HasValue;
    private bool _isRetrospectiveMode = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadProject();
        await LoadEditDates();
        await LoadTasks();
    }

    /// <summary>
    /// 編集日一覧を取得
    /// </summary>
    private async Task LoadEditDates()
    {
        try
        {
            var query = new GetProjectEditDatesQuery(Id, Ascending: false);
            _editDates = await Mediator.Send(query);
        }
        catch (Exception ex)
        {
            errorMessage = $"編集日一覧の読み込みに失敗しました: {ex.Message}";
            _editDates = new List<DateTime>();
        }
    }

    private async Task LoadProject()
    {
        try
        {
            var query = new GetProjectByIdQuery(Id);
            project = await Mediator.Send(query);
        }
        catch (Exception ex)
        {
            errorMessage = $"プロジェクトの読み込みに失敗しました: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadTasks()
    {
        try
        {
            isLoadingTasks = true;

            if (_isViewingPast)
            {
                // 過去時点のタスク一覧を取得
                var query = new GetTasksByProjectIdAtTimeQuery(Id, _currentViewDate!.Value);
                tasks = await Mediator.Send(query);
            }
            else
            {
                // 最新のタスク一覧を取得
                var query = new GetTasksByProjectIdQuery(Id);
                tasks = await Mediator.Send(query);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"タスクの読み込みに失敗しました: {ex.Message}";
            tasks = new List<TaskDto>();
        }
        finally
        {
            isLoadingTasks = false;
        }
    }

    private void ShowCreateTaskModal()
    {
        // 過去表示中は新規作成不可
        if (_isViewingPast)
        {
            errorMessage = "過去の状態を表示中のため、タスクを作成できません。";
            return;
        }

        selectedTask = null;
        showTaskModal = true;
    }

    private void ShowTaskDetailModal(TaskDto task)
    {
        // 過去表示中は読み取り専用で表示（今後、読み取り専用モーダルを実装する場合はここで分岐）
        // 現状は過去表示中でも詳細を確認できるようにする
        selectedTask = task;
        showTaskModal = true;
    }

    private async Task HandleTaskModalSuccess()
    {
        showTaskModal = false;
        selectedTask = null;
        // タスク一覧を再読み込み
        await LoadTasks();
        // 編集日一覧も更新（新しい編集日が追加された可能性があるため）
        await LoadEditDates();
        StateHasChanged();
    }

    private void HandleTaskModalCancel()
    {
        showTaskModal = false;
        selectedTask = null;
    }

    /// <summary>
    /// タイムラインコントロールで日付が変更された際の処理
    /// </summary>
    private async Task HandleDateChanged(DateTime? newDate)
    {
        _currentViewDate = newDate;
        await LoadTasks();
        StateHasChanged();
    }

    private async Task HandleBarResize((Guid taskId, string barType, DateTime newStartDate, DateTime newEndDate) resizeData)
    {
        // 過去表示中は編集不可
        if (_isViewingPast)
        {
            errorMessage = "過去の状態を表示中のため、編集できません。";
            return;
        }

        try
        {
            var task = tasks?.FirstOrDefault(t => t.Id == resizeData.taskId);
            if (task == null) return;

            if (resizeData.barType == "scheduled")
            {
                // 予定期間を更新
                var command = new ChangeTaskScheduleCommand(
                    TaskId: task.Id,
                    ScheduledStartDate: resizeData.newStartDate,
                    ScheduledEndDate: resizeData.newEndDate,
                    EstimatedHours: task.EstimatedHours ?? 0,
                    ChangedBy: "current-user" // TODO: 実際のユーザーIDを使用
                );

                await Mediator.Send(command);
            }
            else if (resizeData.barType == "actual")
            {
                // 実績期間を更新
                var command = new ChangeTaskActualPeriodCommand(
                    TaskId: task.Id,
                    ActualStartDate: resizeData.newStartDate,
                    ActualEndDate: resizeData.newEndDate,
                    ActualHours: task.ActualHours,
                    ChangedBy: "current-user" // TODO: 実際のユーザーIDを使用
                );

                await Mediator.Send(command);
            }

            // タスク一覧を再読み込み
            await LoadTasks();
            // 編集日一覧も更新（新しい編集日が追加された可能性があるため）
            await LoadEditDates();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"タスクの期間更新に失敗しました: {ex.Message}";
        }
    }

    private async Task ToggleRetrospectiveMode()
    {
        _isRetrospectiveMode = !_isRetrospectiveMode;
        
        // 振り返りモードを終了する際は、最新状態に戻す
        if (!_isRetrospectiveMode && _isViewingPast)
        {
            _currentViewDate = null;
            await LoadTasks();
        }
    }
}
