@page "/projects/{id:guid}"
@rendermode InteractiveServer
@using MediatR
@using RewindPM.Application.Read.Queries.Projects
@using RewindPM.Application.Read.Queries.Tasks
@using RewindPM.Application.Read.DTOs
@using RewindPM.Application.Write.Commands.Tasks
@using RewindPM.Web.Components.Pages.Tasks
@using RewindPM.Web.Components.Tasks
@using RewindPM.Web.Components.Shared
@using RewindPM.Web.Components.Statistics
@using TaskStatus = RewindPM.Domain.ValueObjects.TaskStatus
@using Microsoft.AspNetCore.WebUtilities
@inject IMediator Mediator
@inject NavigationManager Navigation
@inject ILogger<Detail> Logger

<PageTitle>@(project?.Title ?? "プロジェクト詳細") - RewindPM</PageTitle>

@if (isLoading)
{
    <div class="loading-state">
        <p><em>読み込み中...</em></p>
    </div>
}
else if (project == null)
{
    <div class="alert alert-danger">プロジェクトが見つかりません。</div>
    <a href="/projects" class="btn btn-secondary">プロジェクト一覧に戻る</a>
}
else
{
    <!-- ヘッダー部 -->
    <div class="project-detail-header">
        <div class="header-left">
            <a href="/projects" class="back-link">← Back to Projects</a>
        </div>
        <div class="header-center">
            <h1 class="project-title">
                @project.Title
                <a href="/projects/@Id/edit" class="btn-icon header-edit-btn" title="Edit Project">
                    Edit
                </a>
            </h1>
        </div>
        <div class="header-right">
            <button class="btn @(_isRetrospectiveMode ? "btn-primary" : "btn-outline-secondary")" @onclick="ToggleRetrospectiveMode">
                Retrospective
            </button>
        </div>
    </div>

    <!-- プロジェクト情報表示 -->
    <div class="project-info">
        @if (!string.IsNullOrWhiteSpace(project.Description))
        {
            <div class="project-description">
                <strong>Description:</strong>
                <p>@project.Description</p>
            </div>
        }
    </div>

    <!-- タイムラインコントロール(リワインド機能) - 振り返りモード時のみ表示 -->
    @if (_isRetrospectiveMode)
    {
        <div class="retrospective-panel">
            <TimelineControl
                CurrentDate="_currentViewDate"
                EditDates="_editDates"
                OnDateChanged="HandleDateChanged" />
        </div>
    }

    <!-- タスクビュー表示エリア -->
    <div class="tasks-section">
        <div class="view-header">
            <div class="view-tabs">
                <button class="view-tab @(_viewType == "Gantt" ? "active" : "")" @onclick='() => ToggleView("Gantt")'>Gantt Chart</button>
                <button class="view-tab @(_viewType == "Kanban" ? "active" : "")" @onclick='() => ToggleView("Kanban")'>Kanban</button>
                <button class="view-tab @(_viewType == "Statistics" ? "active" : "")" @onclick='() => ToggleView("Statistics")'>Statistics</button>
            </div>
            <div class="view-actions">
                <button class="btn btn-success" @onclick="ShowCreateTaskModal" disabled="@_isViewingPast">Add Task</button>
            </div>
        </div>

        @if (_viewType == "Gantt")
        {
            @if (isLoadingTasks)
            {
                <p><em>タスクを読み込み中...</em></p>
            }
            else
            {
                <GanttChart Tasks="@(tasks ?? new List<TaskDto>())"
                            OnTaskClick="ShowTaskDetailModal"
                            OnBarResize="HandleBarResize"
                            ViewDate="_currentViewDate"
                            IsReadOnly="_isViewingPast" />
            }
        }
        else if (_viewType == "Statistics")
        {
            <ProjectStatisticsDashboard ProjectId="@Id" AsOfDate="@(_isRetrospectiveMode ? _currentViewDate : null)" />
        }
        else
        {
            <KanbanBoard Tasks="@(tasks ?? new List<TaskDto>())"
                         OnTaskClick="ShowTaskDetailModal"
                         OnTaskStatusChanged="HandleTaskStatusChanged"
                         IsReadOnly="_isViewingPast" />
        }
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger mt-3">@errorMessage</div>
    }

    <!-- タスク作成・編集モーダル -->
    <TaskFormModal @bind-IsVisible="showTaskModal"
                   ProjectId="@Id"
                   ExistingTask="@selectedTask"
                   OnSuccess="HandleTaskModalSuccess"
                   OnCancel="HandleTaskModalCancel"
                   IsReadOnly="_isViewingPast" />
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private ProjectDto? project;
    private List<TaskDto>? tasks;
    private bool isLoading = true;
    private bool isLoadingTasks = true;
    private string? errorMessage;
    private bool showTaskModal = false;
    private TaskDto? selectedTask = null;

    // リワインド機能用の状態
    private DateTimeOffset? _currentViewDate = null; // null = 最新
    private List<DateTimeOffset> _editDates = new();
    private bool _isViewingPast => _currentViewDate.HasValue;
    private bool _isRetrospectiveMode = false;
    
    // ビュー切り替え用の状態
    private string _viewType = "Gantt";
    private Guid? _previousId = null; // 前回のIdパラメータ値
    private string? _previousTabQuery = null; // 前回のtabクエリパラメータ値

    private void ToggleView(string viewType)
    {
        _viewType = viewType;

        // URLクエリパラメータを更新
        var uri = Navigation.GetUriWithQueryParameter("tab", viewType.ToLower());
        Navigation.NavigateTo(uri, false);
        
        // 前回のクエリパラメータを更新（OnParametersSetでの二重設定を防ぐ）
        _previousTabQuery = viewType.ToLower();
    }

    private async Task HandleTaskStatusChanged((TaskDto task, TaskStatus newStatus) changeData)
    {
        if (_isViewingPast) return;

        try
        {
            var command = new ChangeTaskStatusCommand(
                TaskId: changeData.task.Id,
                NewStatus: changeData.newStatus,
                ChangedBy: GetCurrentUserId() // 認証サービスから取得
            );

            await Mediator.Send(command);
            
            // タスク一覧を再読み込み
            await LoadTasks();
            // 編集日一覧も更新
            await LoadEditDates();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to update task status for task {TaskId}", changeData.task.Id);
            errorMessage = "ステータスの更新に失敗しました。もう一度お試しください。";
        }
    }

    protected override void OnParametersSet()
    {
        // URLクエリパラメータからタブの状態を読み取る
        var uri = new Uri(Navigation.Uri);
        var queryParams = QueryHelpers.ParseQuery(uri.Query);
        
        // StringValuesから最初の値を明示的に取得（複数値の場合の予期しない動作を防ぐ）
        var currentTabQuery = queryParams.TryGetValue("tab", out var tabValue) 
            ? tabValue.FirstOrDefault()?.ToLower() 
            : null;

        // Idパラメータが変更された場合、または tabクエリパラメータが変更された場合のみタブ状態を更新
        var isIdChanged = _previousId != Id;
        var isTabQueryChanged = _previousTabQuery != currentTabQuery;

        if (isIdChanged || isTabQueryChanged)
        {
            _previousId = Id;
            _previousTabQuery = currentTabQuery;

            // クエリパラメータに基づいてタブ状態を設定（nullまたは空の場合はデフォルト）
            _viewType = currentTabQuery switch
            {
                "gantt" => "Gantt",
                "kanban" => "Kanban",
                "statistics" => "Statistics",
                null or "" => "Gantt", // デフォルト
                _ => "Gantt" // 無効な値の場合もデフォルト
            };
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadProject();
        await LoadEditDates();
        await LoadTasks();
    }

    /// <summary>
    /// 編集日一覧を取得
    /// </summary>
    private async Task LoadEditDates()
    {
        try
        {
            var query = new GetProjectEditDatesQuery(Id, Ascending: false);
            _editDates = await Mediator.Send(query);
        }
        catch (Exception ex)
        {
            errorMessage = $"編集日一覧の読み込みに失敗しました: {ex.Message}";
            _editDates = new List<DateTimeOffset>();
        }
    }

    private async Task LoadProject()
    {
        try
        {
            var query = new GetProjectByIdQuery(Id);
            project = await Mediator.Send(query);
        }
        catch (Exception ex)
        {
            errorMessage = $"プロジェクトの読み込みに失敗しました: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadTasks()
    {
        try
        {
            isLoadingTasks = true;

            if (_isViewingPast)
            {
                // 過去時点のタスク一覧を取得
                var query = new GetTasksByProjectIdAtTimeQuery(Id, _currentViewDate!.Value);
                tasks = await Mediator.Send(query);
            }
            else
            {
                // 最新のタスク一覧を取得
                var query = new GetTasksByProjectIdQuery(Id);
                tasks = await Mediator.Send(query);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"タスクの読み込みに失敗しました: {ex.Message}";
            tasks = new List<TaskDto>();
        }
        finally
        {
            isLoadingTasks = false;
        }
    }

    private void ShowCreateTaskModal()
    {
        // 過去表示中は新規作成不可
        if (_isViewingPast)
        {
            errorMessage = "過去の状態を表示中のため、タスクを作成できません。";
            return;
        }

        selectedTask = null;
        showTaskModal = true;
    }

    private void ShowTaskDetailModal(TaskDto task)
    {
        // 過去表示中は読み取り専用で表示（今後、読み取り専用モーダルを実装する場合はここで分岐）
        // 現状は過去表示中でも詳細を確認できるようにする
        selectedTask = task;
        showTaskModal = true;
    }

    private async Task HandleTaskModalSuccess()
    {
        showTaskModal = false;
        selectedTask = null;
        // タスク一覧を再読み込み
        await LoadTasks();
        // 編集日一覧も更新（新しい編集日が追加された可能性があるため）
        await LoadEditDates();
        StateHasChanged();
    }

    private void HandleTaskModalCancel()
    {
        showTaskModal = false;
        selectedTask = null;
    }

    /// <summary>
    /// タイムラインコントロールで日付が変更された際の処理
    /// </summary>
    private async Task HandleDateChanged(DateTimeOffset? newDate)
    {
        _currentViewDate = newDate;
        await LoadTasks();
        StateHasChanged();
    }

    private async Task HandleBarResize((Guid taskId, string barType, DateTimeOffset newStartDate, DateTimeOffset newEndDate) resizeData)
    {
        // 過去表示中は編集不可
        if (_isViewingPast)
        {
            errorMessage = "過去の状態を表示中のため、編集できません。";
            return;
        }

        try
        {
            var task = tasks?.FirstOrDefault(t => t.Id == resizeData.taskId);
            if (task == null) return;

            if (resizeData.barType == "scheduled")
            {
                // 予定期間を更新
                var command = new ChangeTaskScheduleCommand(
                    TaskId: task.Id,
                    ScheduledStartDate: resizeData.newStartDate,
                    ScheduledEndDate: resizeData.newEndDate,
                    EstimatedHours: task.EstimatedHours ?? 0,
                    ChangedBy: "current-user" // TODO: 実際のユーザーIDを使用
                );

                await Mediator.Send(command);
            }
            else if (resizeData.barType == "actual")
            {
                // 実績期間を更新
                var command = new ChangeTaskActualPeriodCommand(
                    TaskId: task.Id,
                    ActualStartDate: resizeData.newStartDate,
                    ActualEndDate: resizeData.newEndDate,
                    ActualHours: task.ActualHours,
                    ChangedBy: "current-user" // TODO: 実際のユーザーIDを使用
                );

                await Mediator.Send(command);
            }

            // タスク一覧を再読み込み
            await LoadTasks();
            // 編集日一覧も更新（新しい編集日が追加された可能性があるため）
            await LoadEditDates();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"タスクの期間更新に失敗しました: {ex.Message}";
        }
    }

    private async Task ToggleRetrospectiveMode()
    {
        _isRetrospectiveMode = !_isRetrospectiveMode;
        
        // 振り返りモードを終了する際は、最新状態に戻す
        if (!_isRetrospectiveMode && _isViewingPast)
        {
            _currentViewDate = null;
            await LoadTasks();
        }
    }

    /// <summary>
    /// 現在のユーザーIDを取得（未実装）
    /// </summary>
    private string GetCurrentUserId()
    {
        // TODO: 認証サービスから実際のユーザーIDを取得する
        return "admin";
    }
}
