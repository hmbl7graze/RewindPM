@using MediatR
@using RewindPM.Application.Read.Queries.Tasks
@using RewindPM.Application.Write.Commands.Projects
@using RewindPM.Application.Write.Commands.Tasks
@using RewindPM.Web.Components.Shared
@inject IMediator Mediator

<Modal Title="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å‰Šé™¤" @bind-IsVisible="IsVisible">
    <div class="delete-modal-content">
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger mb-3">
                <strong>ã‚¨ãƒ©ãƒ¼:</strong> @errorMessage
            </div>
        }

        <div class="warning-section">
            <div class="warning-icon">
                <span>âš </span>
            </div>
            <div class="warning-content">
                <h4 class="warning-title">ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“</h4>
                @if (taskCount > 0)
                {
                    <p class="warning-message">
                        ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã€é–¢é€£ã™ã‚‹<span class="task-count-badge">@taskCount å€‹</span>ã®ã‚¿ã‚¹ã‚¯ãŒã™ã¹ã¦å®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚
                    </p>
                }
                else
                {
                    <p class="warning-message">
                        ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚
                    </p>
                }
            </div>
        </div>

        <div class="danger-notice">
            <span class="danger-notice-icon">ğŸ—‘ï¸</span>
            <p class="danger-notice-text">
                å‰Šé™¤ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯å¾©å…ƒã§ãã¾ã›ã‚“ã€‚æœ¬å½“ã«å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ
            </p>
        </div>

        <div class="modal-footer-actions">
            <button type="button" class="btn btn-secondary" @onclick="HandleCancel" disabled="@isDeleting">
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            @if (isDeleting)
            {
                <button class="btn btn-danger" type="button" disabled>
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    å‰Šé™¤ä¸­...
                </button>
            }
            else
            {
                <button type="button" class="btn btn-danger" @onclick="ConfirmDelete">
                    <strong>å‰Šé™¤ã‚’å®Ÿè¡Œ</strong>
                </button>
            }
        </div>
    </div>
</Modal>

@code {
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }

    [Parameter]
    public Guid ProjectId { get; set; }

    [Parameter]
    public int TaskCount { get; set; }

    [Parameter]
    public string DeletedBy { get; set; } = "test-user";

    [Parameter]
    public EventCallback OnSuccess { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    private bool isDeleting = false;
    private int taskCount = 0;
    private string? errorMessage;

    protected override void OnParametersSet()
    {
        taskCount = TaskCount;
        errorMessage = null;
    }

    private async Task ConfirmDelete()
    {
        try
        {
            isDeleting = true;
            errorMessage = null;

            var deletedBy = !string.IsNullOrWhiteSpace(DeletedBy) ? DeletedBy : "test-user";

            // ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤: å…ˆã«ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤
            if (taskCount > 0)
            {
                var tasksQuery = new GetTasksByProjectIdQuery(ProjectId);
                var tasks = await Mediator.Send(tasksQuery);

                foreach (var task in tasks)
                {
                    var deleteTaskCommand = new DeleteTaskCommand(
                        TaskId: task.Id,
                        DeletedBy: deletedBy
                    );
                    await Mediator.Send(deleteTaskCommand);
                }
            }

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤
            var command = new DeleteProjectCommand(
                ProjectId: ProjectId,
                DeletedBy: deletedBy
            );

            await Mediator.Send(command);

            await OnSuccess.InvokeAsync();
            await CloseModal();
        }
        catch (Exception ex)
        {
            errorMessage = $"ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: {ex.Message}";
            isDeleting = false;
        }
    }

    private async Task HandleCancel()
    {
        await CloseModal();
        await OnCancel.InvokeAsync();
    }

    private async Task CloseModal()
    {
        errorMessage = null;
        isDeleting = false;
        await IsVisibleChanged.InvokeAsync(false);
    }
}
